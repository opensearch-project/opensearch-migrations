// Jest Snapshot v1, https://jestjs.io/docs/snapshot-testing

exports[`WorkflowCommandOrchestrator workflow template matches snapshot (structure regression guard) 1`] = `
{
  "metadata": {
    "entrypoint": "main",
    "k8sMetadata": {
      "name": "full-migration-with-cli",
    },
    "name": "",
    "parallelism": 1,
    "serviceAccountName": "argo-workflow-executor",
  },
  "templates": {
    "configureAndSubmitWorkflow": {
      "body": {
        "container": {
          "args": [
            "
set -e -x

echo "Building and submitting migration workflow..."

# Create migration config JSON
cat > /tmp/migration_config.json << 'EOF'
{
  "sourceClusters": {
    "source": {
      "endpoint": "{{inputs.parameters.sourceEndpoint}}",
      "allowInsecure": {{inputs.parameters.sourceAllowInsecure}},
      "version": "{{inputs.parameters.sourceVersion}}",
      "snapshotRepo": {{inputs.parameters.snapshotConfig}}
    }
  },
  "targetClusters": {
    "target": {{inputs.parameters.targetConfig}}
  },
  "migrationConfigs": [
    {
      "fromSource": "source",
      "toTarget": "target",
      "snapshotExtractAndLoadConfigs": [
        {
          "createSnapshotConfig": {
            "s3RoleArn": "arn:aws:iam::123456789012:role/test-migration-role"
          },
          "snapshotConfig": {
            "snapshotNameConfig": {
              "snapshotNamePrefix": "rfs"
            }
          },
          "migrations": [
            {
              "metadataMigrationConfig": {
                "indexAllowlist": ["*"]
              },
              "documentBackfillConfig": {
                "indexAllowlist": ["*"]
              }
            }
          ]
        }
      ]
    }
  ]
}
EOF

echo "Migration config contents:"
cat /tmp/migration_config.json

. /etc/profile.d/venv.sh
source /.venv/bin/activate

# Clear and load configuration
echo "Clearing existing workflow configuration..."
workflow configure clear --confirm

echo "Loading configuration from JSON..."
cat /tmp/migration_config.json | workflow configure edit --stdin

# Submit workflow and capture the workflow name
echo "Submitting workflow..."
WORKFLOW_OUTPUT=$(workflow submit 2>&1)
echo "Workflow submit output: $WORKFLOW_OUTPUT"

# Extract workflow name (format: "  Name: workflow-name")
WORKFLOW_NAME=$(echo "$WORKFLOW_OUTPUT" | grep "Name:" | awk '{print $2}' | tr -d '
')

if [ -z "$WORKFLOW_NAME" ]; then
    echo "ERROR: Could not extract workflow name from output"
    echo "Full output was: $WORKFLOW_OUTPUT"
    exit 1
fi

echo "Workflow submitted successfully: $WORKFLOW_NAME"
mkdir -p /tmp/outputs
echo "$WORKFLOW_NAME" > /tmp/outputs/workflowName
sync
sleep 2
",
          ],
          "command": [
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "/bin/sh",
            },
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "-c",
            },
          ],
          "env": {},
          "image": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsoleLocation",
            },
          },
          "imagePullPolicy": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsolePullPolicy",
            },
          },
          "resources": {
            "limits": {
              "cpu": "1000m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
      },
      "inputs": {
        "imageMigrationConsoleLocation": {
          "description": undefined,
        },
        "imageMigrationConsolePullPolicy": {
          "description": undefined,
        },
        "snapshotConfig": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "",
            },
          },
          "description": "Snapshot config as JSON object fragment",
        },
        "sourceAllowInsecure": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "true",
            },
          },
          "description": "Allow insecure connections to source cluster",
        },
        "sourceEndpoint": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "",
            },
          },
          "description": "Source cluster endpoint URL",
        },
        "sourceVersion": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "",
            },
          },
          "description": "Source cluster version (e.g. ES_5.6, OS_2.19)",
        },
        "targetConfig": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "",
            },
          },
          "description": "Target cluster config as JSON object fragment",
        },
      },
      "outputs": {
        "workflowName": {
          "description": "Name of the submitted workflow",
          "fromWhere": "path",
          "path": "/tmp/outputs/workflowName",
        },
      },
      "retryStrategy": {},
    },
    "main": {
      "body": {
        "steps": [
          {
            "steps": [
              {
                "args": {
                  "imageMigrationConsoleLocation": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsoleLocation",
                    },
                  },
                  "imageMigrationConsolePullPolicy": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsolePullPolicy",
                    },
                  },
                  "snapshotConfig": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": "Snapshot configuration as JSON object fragment",
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "snapshotConfigJson",
                    },
                  },
                  "sourceAllowInsecure": "{{=jsonpath(inputs.parameters.sourceClusterConfigJson, '$.allow_insecure')}}",
                  "sourceEndpoint": "{{=jsonpath(inputs.parameters.sourceClusterConfigJson, '$.endpoint')}}",
                  "sourceVersion": "{{=jsonpath(inputs.parameters.sourceClusterConfigJson, '$.version')}}",
                  "targetConfig": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": "Target cluster configuration as JSON object fragment",
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "targetClusterConfigJson",
                    },
                  },
                },
                "name": "configureAndSubmitWorkflow",
                "template": "configureAndSubmitWorkflow",
              },
            ],
          },
          {
            "steps": [
              {
                "args": {
                  "imageMigrationConsoleLocation": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsoleLocation",
                    },
                  },
                  "imageMigrationConsolePullPolicy": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsolePullPolicy",
                    },
                  },
                  "workflowName": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": "Name of the submitted workflow",
                      "fromWhere": "path",
                      "path": "/tmp/outputs/workflowName",
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "steps_output",
                      "parameterName": "workflowName",
                      "stepName": "configureAndSubmitWorkflow",
                    },
                  },
                },
                "name": "monitorWorkflow",
                "template": "monitorWorkflow",
              },
            ],
          },
        ],
      },
      "inputs": {
        "imageMigrationConsoleLocation": {
          "description": undefined,
        },
        "imageMigrationConsolePullPolicy": {
          "description": undefined,
        },
        "snapshotConfigJson": {
          "description": "Snapshot configuration as JSON object fragment",
        },
        "sourceClusterConfigJson": {
          "description": "Source cluster configuration as JSON object fragment (e.g. {"endpoint":"..."})",
        },
        "targetClusterConfigJson": {
          "description": "Target cluster configuration as JSON object fragment",
        },
      },
      "outputs": {},
      "retryStrategy": {},
    },
    "monitorWorkflow": {
      "body": {
        "container": {
          "args": [
            "
set -e -x

WORKFLOW_NAME="{{inputs.parameters.workflowName}}"
echo "Checking workflow status: $WORKFLOW_NAME"

. /etc/profile.d/venv.sh
source /.venv/bin/activate

# Simple status check - let Argo handle retries and persistence
STATUS_OUTPUT=$(workflow status --name "$WORKFLOW_NAME" 2>&1)
echo "Status: $STATUS_OUTPUT"

# Check if workflow is completed successfully
if echo "$STATUS_OUTPUT" | grep -q "Succeeded"; then
    echo "✅ Workflow completed successfully"
    exit 0
fi

# Check if workflow failed permanently 
if echo "$STATUS_OUTPUT" | grep -q "Failed"; then
    echo "❌ Workflow failed permanently"
    exit 1
fi

# Handle suspended workflow (needs approval)
if echo "$STATUS_OUTPUT" | grep -q "Suspended\\|Waiting"; then
    echo "Workflow is suspended, attempting to approve..."
    APPROVE_OUTPUT=$(workflow approve --name "$WORKFLOW_NAME" 2>&1)
    echo "Approve output: $APPROVE_OUTPUT"
    
    if echo "$APPROVE_OUTPUT" | grep -q "approved\\|Approved"; then
        echo "Workflow approved, will check again..."
    else
        echo "Warning: Approval may have failed: $APPROVE_OUTPUT"
    fi
    exit 1  # Exit 1 to retry after approval
fi

# Workflow is still running - exit 1 to trigger retry
if echo "$STATUS_OUTPUT" | grep -q "Running\\|Pending"; then
    echo "⏳ Workflow still running, will retry..."
    exit 1
fi

# Unknown status - retry
echo "Unknown workflow status, will retry..."
exit 1
",
          ],
          "command": [
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "/bin/sh",
            },
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "-c",
            },
          ],
          "env": {},
          "image": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsoleLocation",
            },
          },
          "imagePullPolicy": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsolePullPolicy",
            },
          },
          "resources": {
            "limits": {
              "cpu": "1000m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
      },
      "inputs": {
        "imageMigrationConsoleLocation": {
          "description": undefined,
        },
        "imageMigrationConsolePullPolicy": {
          "description": undefined,
        },
        "workflowName": {
          "description": undefined,
        },
      },
      "outputs": {},
      "retryStrategy": {
        "backoff": {
          "cap": "300",
          "duration": "5",
          "factor": "2",
        },
        "limit": "864",
        "retryPolicy": "Always",
      },
    },
  },
  "workflowParameters": {
    "approvalConfigMapName": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "approval-config",
      },
      "description": undefined,
    },
    "etcdEndpoints": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "http://etcd.ma.svc.cluster.local:2379",
      },
      "description": undefined,
    },
    "etcdPassword": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "password",
      },
      "description": undefined,
    },
    "etcdUser": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "root",
      },
      "description": undefined,
    },
    "imageConfigMapName": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "migration-image-config",
      },
      "description": undefined,
    },
    "s3SnapshotConfigMap": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "s3-snapshot-config",
      },
      "description": undefined,
    },
  },
}
`;
