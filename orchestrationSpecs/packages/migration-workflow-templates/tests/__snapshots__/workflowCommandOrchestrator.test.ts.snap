// Jest Snapshot v1, https://jestjs.io/docs/snapshot-testing

exports[`WorkflowCommandOrchestrator workflow template matches snapshot (structure regression guard) 1`] = `
{
  "metadata": {
    "entrypoint": "main",
    "k8sMetadata": {
      "name": "workflow-command-orchestrator",
    },
    "name": "",
    "parallelism": 1,
    "serviceAccountName": "argo-workflow-executor",
  },
  "templates": {
    "configureWorkflow": {
      "body": {
        "container": {
          "args": [
            TemplateReplacementExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "fillTemplate",
              "replacements": {
                "SNAPSHOT_CONFIG": FromParameterExpression {
                  "_complexity": undefined,
                  "_paramDef": {
                    "_hasDefault": true,
                    "defaultValue": {
                      "expression": LiteralExpression {
                        "_complexity": undefined,
                        "_resultType": undefined,
                        "kind": "literal",
                        "value": "",
                      },
                    },
                    "description": "Snapshot config as JSON object fragment",
                  },
                  "_resultType": undefined,
                  "kind": "parameter",
                  "source": {
                    "kind": "input",
                    "parameterName": "snapshotConfig",
                  },
                },
                "SOURCE_CONFIG": FromParameterExpression {
                  "_complexity": undefined,
                  "_paramDef": {
                    "_hasDefault": true,
                    "defaultValue": {
                      "expression": LiteralExpression {
                        "_complexity": undefined,
                        "_resultType": undefined,
                        "kind": "literal",
                        "value": "",
                      },
                    },
                    "description": "Source cluster config as JSON object fragment (e.g. {"endpoint":"..."})",
                  },
                  "_resultType": undefined,
                  "kind": "parameter",
                  "source": {
                    "kind": "input",
                    "parameterName": "sourceConfig",
                  },
                },
                "TARGET_CONFIG": FromParameterExpression {
                  "_complexity": undefined,
                  "_paramDef": {
                    "_hasDefault": true,
                    "defaultValue": {
                      "expression": LiteralExpression {
                        "_complexity": undefined,
                        "_resultType": undefined,
                        "kind": "literal",
                        "value": "",
                      },
                    },
                    "description": "Target cluster config as JSON object fragment",
                  },
                  "_resultType": undefined,
                  "kind": "parameter",
                  "source": {
                    "kind": "input",
                    "parameterName": "targetConfig",
                  },
                },
              },
              "template": "
set -e -x

# Save pod name to output path
echo $HOSTNAME > /tmp/podname

echo "Building migration configuration..."

# Create migration config JSON
cat > /tmp/migration_config.json << 'EOF'
{
  "source_cluster": {{SOURCE_CONFIG}},
  "target_cluster": {{TARGET_CONFIG}},
  "snapshot": {{SNAPSHOT_CONFIG}},
  "backfill": {
    "reindex_from_snapshot": true
  },
  "metadata_migration": {
    "index_allowlist": "*"
  }
}
EOF

echo "Migration config contents:"
cat /tmp/migration_config.json

echo "Configuring workflow..."
. /etc/profile.d/venv.sh
source /.venv/bin/activate

workflow configure --config-file /tmp/migration_config.json

echo "Workflow configured successfully"
",
            },
          ],
          "command": [
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "/bin/sh",
            },
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "-c",
            },
          ],
          "env": {},
          "image": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsoleLocation",
            },
          },
          "imagePullPolicy": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsolePullPolicy",
            },
          },
          "resources": {
            "limits": {
              "cpu": "1000m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
      },
      "inputs": {
        "imageMigrationConsoleLocation": {
          "description": undefined,
        },
        "imageMigrationConsolePullPolicy": {
          "description": undefined,
        },
        "snapshotConfig": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "",
            },
          },
          "description": "Snapshot config as JSON object fragment",
        },
        "sourceConfig": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "",
            },
          },
          "description": "Source cluster config as JSON object fragment (e.g. {"endpoint":"..."})",
        },
        "targetConfig": {
          "_hasDefault": true,
          "defaultValue": {
            "expression": LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "",
            },
          },
          "description": "Target cluster config as JSON object fragment",
        },
      },
      "outputs": {},
      "retryStrategy": {},
    },
    "main": {
      "body": {
        "steps": [
          {
            "steps": [
              {
                "args": {
                  "imageMigrationConsoleLocation": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsoleLocation",
                    },
                  },
                  "imageMigrationConsolePullPolicy": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsolePullPolicy",
                    },
                  },
                  "snapshotConfig": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": "Snapshot configuration as JSON object fragment",
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "snapshotConfigJson",
                    },
                  },
                  "sourceConfig": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": "Source cluster configuration as JSON object fragment (e.g. {"endpoint":"..."})",
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "sourceClusterConfigJson",
                    },
                  },
                  "targetConfig": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": "Target cluster configuration as JSON object fragment",
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "targetClusterConfigJson",
                    },
                  },
                },
                "name": "configureWorkflow",
                "template": "configureWorkflow",
              },
            ],
          },
          {
            "steps": [
              {
                "args": {
                  "imageMigrationConsoleLocation": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsoleLocation",
                    },
                  },
                  "imageMigrationConsolePullPolicy": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsolePullPolicy",
                    },
                  },
                },
                "name": "submitWorkflow",
                "template": "submitWorkflow",
              },
            ],
          },
          {
            "steps": [
              {
                "args": {
                  "imageMigrationConsoleLocation": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsoleLocation",
                    },
                  },
                  "imageMigrationConsolePullPolicy": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": undefined,
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "input",
                      "parameterName": "imageMigrationConsolePullPolicy",
                    },
                  },
                  "workflowName": FromParameterExpression {
                    "_complexity": undefined,
                    "_paramDef": {
                      "description": "Name of the submitted workflow",
                      "fromWhere": "path",
                      "path": "/tmp/outputs/workflowName",
                    },
                    "_resultType": undefined,
                    "kind": "parameter",
                    "source": {
                      "kind": "steps_output",
                      "parameterName": "workflowName",
                      "stepName": "submitWorkflow",
                    },
                  },
                },
                "name": "monitorWorkflow",
                "template": "monitorWorkflow",
              },
            ],
          },
        ],
      },
      "inputs": {
        "imageMigrationConsoleLocation": {
          "description": undefined,
        },
        "imageMigrationConsolePullPolicy": {
          "description": undefined,
        },
        "snapshotConfigJson": {
          "description": "Snapshot configuration as JSON object fragment",
        },
        "sourceClusterConfigJson": {
          "description": "Source cluster configuration as JSON object fragment (e.g. {"endpoint":"..."})",
        },
        "targetClusterConfigJson": {
          "description": "Target cluster configuration as JSON object fragment",
        },
      },
      "outputs": {},
      "retryStrategy": {},
    },
    "monitorWorkflow": {
      "body": {
        "container": {
          "args": [
            TemplateReplacementExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "fillTemplate",
              "replacements": {
                "WORKFLOW_NAME": FromParameterExpression {
                  "_complexity": undefined,
                  "_paramDef": {
                    "description": undefined,
                  },
                  "_resultType": undefined,
                  "kind": "parameter",
                  "source": {
                    "kind": "input",
                    "parameterName": "workflowName",
                  },
                },
              },
              "template": "
set -e -x

WORKFLOW_NAME="{{WORKFLOW_NAME}}"
echo "Monitoring workflow: $WORKFLOW_NAME"

. /etc/profile.d/venv.sh
source /.venv/bin/activate

# Poll workflow status with timeout (30 minutes max)
MAX_ITERATIONS=360  # 30 minutes at 5-second intervals
ITERATION=0

while [ $ITERATION -lt $MAX_ITERATIONS ]; do
    echo "Checking workflow status (iteration $((ITERATION + 1))/$MAX_ITERATIONS)..."
    
    # Get workflow status
    STATUS_OUTPUT=$(workflow status --name "$WORKFLOW_NAME" 2>&1 || echo "ERROR")
    
    if echo "$STATUS_OUTPUT" | grep -q "ERROR"; then
        echo "Error getting workflow status: $STATUS_OUTPUT"
        sleep 5
        ITERATION=$((ITERATION + 1))
        continue
    fi
    
    echo "Status output: $STATUS_OUTPUT"
    
    # Check if workflow is completed (succeeded or failed)
    if echo "$STATUS_OUTPUT" | grep -q "Succeeded\\|Failed"; then
        if echo "$STATUS_OUTPUT" | grep -q "Succeeded"; then
            echo "✅ Workflow completed successfully!"
            exit 0
        else
            echo "❌ Workflow failed!"
            exit 1
        fi
    fi
    
    # Check if workflow needs approval (suspended)
    if echo "$STATUS_OUTPUT" | grep -q "Suspended\\|Waiting"; then
        echo "Workflow is suspended, attempting to approve..."
        APPROVE_OUTPUT=$(workflow approve --name "$WORKFLOW_NAME" 2>&1)
        echo "Approve output: $APPROVE_OUTPUT"
        
        if echo "$APPROVE_OUTPUT" | grep -q "approved\\|Approved"; then
            echo "Workflow approved, continuing monitoring..."
        else
            echo "Warning: Approval may have failed: $APPROVE_OUTPUT"
        fi
    fi
    
    # Check if workflow is still running
    if echo "$STATUS_OUTPUT" | grep -q "Running\\|Pending"; then
        echo "Workflow is still running, waiting..."
    fi
    
    sleep 5
    ITERATION=$((ITERATION + 1))
done

echo "❌ Timeout: Workflow did not complete within 30 minutes"
exit 1
",
            },
          ],
          "command": [
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "/bin/sh",
            },
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "-c",
            },
          ],
          "env": {},
          "image": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsoleLocation",
            },
          },
          "imagePullPolicy": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsolePullPolicy",
            },
          },
          "resources": {
            "limits": {
              "cpu": "1000m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
      },
      "inputs": {
        "imageMigrationConsoleLocation": {
          "description": undefined,
        },
        "imageMigrationConsolePullPolicy": {
          "description": undefined,
        },
        "workflowName": {
          "description": undefined,
        },
      },
      "outputs": {},
      "retryStrategy": {},
    },
    "submitWorkflow": {
      "body": {
        "container": {
          "args": [
            "
set -e -x

echo "Submitting workflow..."

. /etc/profile.d/venv.sh
source /.venv/bin/activate

# Submit workflow and capture the workflow name
WORKFLOW_OUTPUT=$(workflow submit 2>&1)
echo "Workflow submit output: $WORKFLOW_OUTPUT"

# Extract workflow name from output (format: "Workflow 'migration-xyz' submitted")
WORKFLOW_NAME=$(echo "$WORKFLOW_OUTPUT" | grep -o "Workflow '[^']*'" | sed "s/Workflow '\\([^']*\\)'/\\1/" || echo "")

if [ -z "$WORKFLOW_NAME" ]; then
    echo "ERROR: Could not extract workflow name from output"
    exit 1
fi

echo "Workflow submitted successfully: $WORKFLOW_NAME"
echo "$WORKFLOW_NAME" > /tmp/workflowName

# Also save to Argo output
mkdir -p /tmp/outputs
echo "$WORKFLOW_NAME" > /tmp/outputs/workflowName
",
          ],
          "command": [
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "/bin/sh",
            },
            LiteralExpression {
              "_complexity": undefined,
              "_resultType": undefined,
              "kind": "literal",
              "value": "-c",
            },
          ],
          "env": {},
          "image": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsoleLocation",
            },
          },
          "imagePullPolicy": FromParameterExpression {
            "_complexity": undefined,
            "_paramDef": {
              "description": undefined,
            },
            "_resultType": undefined,
            "kind": "parameter",
            "source": {
              "kind": "input",
              "parameterName": "imageMigrationConsolePullPolicy",
            },
          },
          "resources": {
            "limits": {
              "cpu": "1000m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
      },
      "inputs": {
        "imageMigrationConsoleLocation": {
          "description": undefined,
        },
        "imageMigrationConsolePullPolicy": {
          "description": undefined,
        },
      },
      "outputs": {
        "workflowName": {
          "description": "Name of the submitted workflow",
          "fromWhere": "path",
          "path": "/tmp/outputs/workflowName",
        },
      },
      "retryStrategy": {},
    },
  },
  "workflowParameters": {
    "etcdEndpoints": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "http://etcd.ma.svc.cluster.local:2379",
      },
      "description": undefined,
    },
    "etcdPassword": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "password",
      },
      "description": undefined,
    },
    "etcdUser": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "root",
      },
      "description": undefined,
    },
    "imageConfigMapName": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "migration-image-config",
      },
      "description": undefined,
    },
    "s3SnapshotConfigMap": {
      "_hasDefault": true,
      "defaultValue": {
        "expression": "s3-snapshot-config",
      },
      "description": undefined,
    },
  },
}
`;
