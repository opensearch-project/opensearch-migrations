{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "metadata-migration"
  },
  "spec": {
    "serviceAccountName": "argo-workflow-executor",
    "parallelism": 100,
    "arguments": {
      "parameters": [
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config"
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config"
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config"
        }
      ]
    },
    "templates": [
      {
        "name": "runmetadata",
        "inputs": {
          "parameters": [
            {
              "name": "commandMode"
            },
            {
              "name": "sourceVersion"
            },
            {
              "name": "targetConfig"
            },
            {
              "name": "snapshotConfig"
            },
            {
              "name": "metadataMigrationConfig"
            },
            {
              "name": "imageMigrationConsoleLocation"
            },
            {
              "name": "imageMigrationConsolePullPolicy"
            },
            {
              "name": "sourceK8sLabel"
            },
            {
              "name": "targetK8sLabel"
            },
            {
              "name": "snapshotK8sLabel"
            },
            {
              "name": "fromSnapshotMigrationK8sLabel"
            },
            {
              "name": "taskK8sLabel",
              "value": "{{=((inputs.parameters.commandMode == 'evaluate') ? ('metadataEvaluate') : ('metadataMigrate'))}}"
            }
          ]
        },
        "container": {
          "env": [
            {
              "name": "AWS_SHARED_CREDENTIALS_FILE",
              "value": "{{=((sprig.dig('repoConfig', 'useLocalStack', false, fromJSON(inputs.parameters.snapshotConfig))) ? ('/config/credentials/configuration') : (''))}}"
            },
            {
              "name": "TARGET_USERNAME",
              "valueFrom": {
                "secretKeyRef": {
                  "name": "{{=((0 == len(sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig)))) ? ('empty') : (sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig))))}}",
                  "key": "username",
                  "optional": true
                }
              }
            },
            {
              "name": "TARGET_PASSWORD",
              "valueFrom": {
                "secretKeyRef": {
                  "name": "{{=((0 == len(sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig)))) ? ('empty') : (sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig))))}}",
                  "key": "password",
                  "optional": true
                }
              }
            }
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi"
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi"
            }
          },
          "command": [
            "/root/metadataMigration/bin/MetadataMigration"
          ],
          "args": [
            "{{inputs.parameters.commandMode}}",
            "---INLINE-JSON",
            "{{=toJSON(sprig.merge(sprig.merge(sprig.merge(sprig.merge((('authConfig' in fromJSON(inputs.parameters.targetConfig)) ? ((('sigv4' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict(\"targetAwsServiceSigningName\", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['service'], \"targetAwsRegion\", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['region'])) : ((('mtls' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict(\"targetCaCert\", fromJSON(inputs.parameters.targetConfig)['authConfig']['mtls']['caCert'])) : ({}))))) : ({})), (('endpoint' in fromJSON(inputs.parameters.targetConfig)) ? (sprig.dict(\"targetHost\", fromJSON(inputs.parameters.targetConfig)['endpoint'])) : ({}))), sprig.dict(\"targetInsecure\", sprig.dig('allowInsecure', false, fromJSON(inputs.parameters.targetConfig)))), sprig.omit(fromJSON(inputs.parameters.metadataMigrationConfig), 'loggingConfigurationOverrideConfigMap')), sprig.merge(sprig.dict(\"snapshotName\", fromJSON(inputs.parameters.snapshotConfig)['snapshotName'], \"sourceVersion\", inputs.parameters.sourceVersion), sprig.merge(sprig.merge(((0 == len(sprig.dig('endpoint', '', sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')))) ? (sprig.dict()) : (sprig.dict(\"s3Endpoint\", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['endpoint']))), ((0 == len(sprig.dig('s3RoleArn', '', sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')))) ? (sprig.dict()) : (sprig.dict(\"s3RoleArn\", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['s3RoleArn'])))), sprig.dict(\"s3RepoUri\", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['s3RepoPathUri'], \"s3Region\", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['awsRegion'], \"s3LocalDir\", '/tmp')))))}}"
          ],
          "volumeMounts": [
            {
              "name": "test-creds",
              "mountPath": "/config/credentials",
              "readOnly": true
            }
          ]
        },
        "metadata": {
          "labels": {
            "migrations.opensearch.org/source": "{{inputs.parameters.sourceK8sLabel}}",
            "migrations.opensearch.org/target": "{{inputs.parameters.targetK8sLabel}}",
            "migrations.opensearch.org/snapshot": "{{inputs.parameters.snapshotK8sLabel}}",
            "migrations.opensearch.org/from-snapshot-migration": "{{inputs.parameters.fromSnapshotMigrationK8sLabel}}",
            "migrations.opensearch.org/task": "{{inputs.parameters.taskK8sLabel}}"
          }
        },
        "volumes": [
          {
            "name": "test-creds",
            "configMap": {
              "name": "localstack-test-creds",
              "optional": true
            }
          }
        ],
        "outputs": {
          "parameters": []
        }
      },
      {
        "name": "approveevaluate",
        "inputs": {
          "parameters": [
            {
              "name": "name"
            }
          ]
        },
        "suspend": {},
        "outputs": {
          "parameters": []
        }
      },
      {
        "name": "approvemigrate",
        "inputs": {
          "parameters": [
            {
              "name": "name"
            }
          ]
        },
        "suspend": {},
        "outputs": {
          "parameters": []
        }
      },
      {
        "name": "migratemetadata",
        "inputs": {
          "parameters": [
            {
              "name": "metadataMigrationConfig"
            },
            {
              "name": "snapshotConfig",
              "description": "Snapshot storage details (region, endpoint, etc)"
            },
            {
              "name": "sourceLabel"
            },
            {
              "name": "sourceVersion"
            },
            {
              "name": "targetConfig"
            },
            {
              "name": "migrationLabel"
            },
            {
              "name": "imageMigrationConsoleLocation"
            },
            {
              "name": "imageMigrationConsolePullPolicy"
            },
            {
              "name": "skipApprovalMap",
              "value": {},
              "valueFrom": {
                "configMapKeyRef": {
                  "name": "{{workflow.parameters.approvalConfigMapName}}",
                  "key": "autoApprove",
                  "optional": true
                }
              }
            },
            {
              "name": "skipEvaluateApproval",
              "value": "{{=sprig.dig(inputs.parameters.sourceLabel, fromJSON(inputs.parameters.targetConfig)['label'], jsonpath(inputs.parameters.snapshotConfig, '$.label'), inputs.parameters.migrationLabel, 'evaluateMetadata', false, fromJSON(inputs.parameters.skipApprovalMap))}}"
            },
            {
              "name": "skipMigrateApproval",
              "value": "{{=sprig.dig(inputs.parameters.sourceLabel, fromJSON(inputs.parameters.targetConfig)['label'], jsonpath(inputs.parameters.snapshotConfig, '$.label'), inputs.parameters.migrationLabel, 'migrateMetadata', false, fromJSON(inputs.parameters.skipApprovalMap))}}"
            },
            {
              "name": "approvalNamePrefix",
              "value": "{{=inputs.parameters.sourceLabel+'.'+jsonpath(inputs.parameters.targetConfig, '$.label')+'.'+jsonpath(inputs.parameters.snapshotConfig, '$.label')+'.'+inputs.parameters.migrationLabel+'.'}}"
            }
          ]
        },
        "steps": [
          [
            {
              "template": "runmetadata",
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceVersion",
                    "value": "{{inputs.parameters.sourceVersion}}"
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}"
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}"
                  },
                  {
                    "name": "metadataMigrationConfig",
                    "value": "{{inputs.parameters.metadataMigrationConfig}}"
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}"
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}"
                  },
                  {
                    "name": "commandMode",
                    "value": "evaluate"
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceLabel}}"
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.targetConfig, '$.label')}}"
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}"
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.migrationLabel}}"
                  }
                ]
              },
              "name": "evaluateMetadata"
            }
          ],
          [
            {
              "template": "approveevaluate",
              "when": "!({{inputs.parameters.skipEvaluateApproval}})",
              "arguments": {
                "parameters": [
                  {
                    "name": "name",
                    "value": "{{=inputs.parameters.approvalNamePrefix+'evaluateMetadata'}}"
                  }
                ]
              },
              "name": "approveEvaluate"
            }
          ],
          [
            {
              "template": "runmetadata",
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceVersion",
                    "value": "{{inputs.parameters.sourceVersion}}"
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}"
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}"
                  },
                  {
                    "name": "metadataMigrationConfig",
                    "value": "{{inputs.parameters.metadataMigrationConfig}}"
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}"
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}"
                  },
                  {
                    "name": "commandMode",
                    "value": "migrate"
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceLabel}}"
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.targetConfig, '$.label')}}"
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}"
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.migrationLabel}}"
                  }
                ]
              },
              "name": "migrateMetadata"
            }
          ],
          [
            {
              "template": "approvemigrate",
              "when": "{{=!(fromJSON(inputs.parameters.skipMigrateApproval))}}",
              "arguments": {
                "parameters": [
                  {
                    "name": "name",
                    "value": "{{=inputs.parameters.approvalNamePrefix+'migrateMetadata'}}"
                  }
                ]
              },
              "name": "approveMigrate"
            }
          ]
        ],
        "outputs": {
          "parameters": []
        }
      }
    ]
  }
}
