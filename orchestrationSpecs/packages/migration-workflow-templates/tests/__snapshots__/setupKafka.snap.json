{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "setup-kafka"
  },
  "spec": {
    "serviceAccountName": "argo-workflow-executor",
    "parallelism": 100,
    "arguments": {
      "parameters": [
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config"
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config"
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config"
        }
      ]
    },
    "templates": [
      {
        "name": "deploykafkanodepool",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            },
            {
              "name": "clusterConfig"
            }
          ]
        },
        "resource": {
          "manifest": "apiVersion: kafka.strimzi.io/v1\nkind: KafkaNodePool\nmetadata:\n  name: dual-role\n  labels:\n    strimzi.io/cluster: \"{{inputs.parameters.clusterName}}\"\nspec:\n  replicas: {{=sprig.dig('replicas', 1, fromJSON(inputs.parameters.clusterConfig))}}\n  roles:\n    - controller\n    - broker\n  storage:\n    type: ephemeral\n",
          "action": "apply",
          "setOwnerReference": true
        },
        "outputs": {
          "parameters": []
        }
      },
      {
        "name": "deploykafkaclusterkraft",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            },
            {
              "name": "version"
            }
          ]
        },
        "resource": {
          "manifest": "apiVersion: kafka.strimzi.io/v1\nkind: Kafka\nmetadata:\n  name: \"{{inputs.parameters.clusterName}}\"\n  annotations:\n    strimzi.io/node-pools: enabled\n    strimzi.io/kraft: enabled\nspec:\n  kafka:\n    version: \"{{inputs.parameters.version}}\"\n    metadataVersion: 4.0-IV3\n    readinessProbe:\n      initialDelaySeconds: 1\n      periodSeconds: 2\n      timeoutSeconds: 2\n      failureThreshold: 1\n    livenessProbe:\n      initialDelaySeconds: 1\n      periodSeconds: 2\n      timeoutSeconds: 2\n      failureThreshold: 2\n    listeners:\n      - name: plain\n        port: 9092\n        type: internal\n        tls: false\n      - name: tls\n        port: 9093\n        type: internal\n        tls: true\n    config:\n      auto.create.topics.enable: false\n      offsets.topic.replication.factor: 1\n      transaction.state.log.replication.factor: 1\n      transaction.state.log.min.isr: 1\n      default.replication.factor: 1\n      min.insync.replicas: 1\n  entityOperator:\n    topicOperator: {}\n    userOperator: {}\n",
          "action": "apply",
          "setOwnerReference": true,
          "successCondition": "status.listeners"
        },
        "outputs": {
          "parameters": [
            {
              "name": "brokers",
              "valueFrom": {
                "jsonPath": "{.status.listeners[?(@.name=='plain')].bootstrapServers}"
              }
            }
          ]
        }
      },
      {
        "name": "deploykafkacluster",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            },
            {
              "name": "version"
            },
            {
              "name": "clusterConfig"
            }
          ]
        },
        "steps": [
          [
            {
              "template": "deploykafkanodepool",
              "arguments": {
                "parameters": [
                  {
                    "name": "clusterName",
                    "value": "{{inputs.parameters.clusterName}}"
                  },
                  {
                    "name": "clusterConfig",
                    "value": "{{inputs.parameters.clusterConfig}}"
                  }
                ]
              },
              "name": "deployPool"
            }
          ],
          [
            {
              "template": "deploykafkaclusterkraft",
              "arguments": {
                "parameters": [
                  {
                    "name": "clusterName",
                    "value": "{{inputs.parameters.clusterName}}"
                  },
                  {
                    "name": "version",
                    "value": "{{inputs.parameters.version}}"
                  }
                ]
              },
              "name": "deployCluster"
            }
          ]
        ],
        "outputs": {
          "parameters": [
            {
              "name": "bootstrapServers",
              "valueFrom": {
                "expression": "steps.deployCluster.outputs.parameters.brokers"
              }
            }
          ]
        }
      },
      {
        "name": "createkafkatopic",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            },
            {
              "name": "topicName"
            },
            {
              "name": "clusterConfig"
            }
          ]
        },
        "resource": {
          "manifest": "apiVersion: kafka.strimzi.io/v1\nkind: KafkaTopic\nmetadata:\n  name: \"{{inputs.parameters.topicName}}\"\n  labels:\n    strimzi.io/cluster: \"{{inputs.parameters.clusterName}}\"\nspec:\n  partitions: {{=sprig.dig('partitions', 1, fromJSON(inputs.parameters.clusterConfig))}}\n  replicas: {{=sprig.dig('topicReplicas', 1, fromJSON(inputs.parameters.clusterConfig))}}\n  config:\n    retention.ms: 604800000\n    segment.bytes: 1073741824\n",
          "action": "apply",
          "setOwnerReference": true,
          "successCondition": "status.topicName"
        },
        "outputs": {
          "parameters": [
            {
              "name": "topicName",
              "valueFrom": {
                "jsonPath": "{.status.topicName}"
              }
            }
          ]
        }
      }
    ]
  }
}
