{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "setup-kafka"
  },
  "spec": {
    "serviceAccountName": "argo-workflow-executor",
    "parallelism": 100,
    "arguments": {
      "parameters": [
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config"
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config"
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config"
        }
      ]
    },
    "templates": [
      {
        "name": "deploykafkaclusterzookeeper",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            }
          ]
        },
        "resource": {
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2\nkind: Kafka\nmetadata:\n  name: \"{{inputs.parameters.clusterName}}\"\nspec:\n  kafka:\n    version: 3.9.0\n    replicas: 1\n    listeners:\n      - name: tls\n        port: 9093\n        type: internal\n        tls: true\n    config:\n      offsets.topic.replication.factor: 1\n      transaction.state.log.replication.factor: 1\n      transaction.state.log.min.isr: 1\n      default.replication.factor: 1\n      min.insync.replicas: 1\n      inter.broker.protocol.version: \"3.9\"\n    storage:\n      type: ephemeral\n  zookeeper:\n    replicas: 3\n    storage:\n      type: ephemeral\n  entityOperator:\n    topicOperator: {}\n    userOperator: {}\n",
          "action": "create",
          "setOwnerReference": true,
          "successCondition": "status.listeners"
        },
        "outputs": {
          "parameters": [
            {
              "name": "brokers",
              "valueFrom": {
                "jsonPath": "{.status.listeners[?(@.name=='plain')].bootstrapServers}"
              }
            }
          ]
        }
      },
      {
        "name": "deploykafkanodepool",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            }
          ]
        },
        "resource": {
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2\nkind: KafkaNodePool\nmetadata:\n  name: dual-role\n  labels:\n    strimzi.io/cluster: \"{{inputs.parameters.clusterName}}\"\nspec:\n  replicas: 1\n  roles:\n    - controller\n    - broker\n  storage:\n    type: jbod\n    volumes:\n      - id: 0\n        type: persistent-claim\n        size: 5Gi\n        deleteClaim: false\n        kraftMetadata: shared\n",
          "action": "apply",
          "setOwnerReference": true
        },
        "outputs": {
          "parameters": []
        }
      },
      {
        "name": "deploykafkaclusterkraft",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            }
          ]
        },
        "resource": {
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2\nkind: Kafka\nmetadata:\n  name: \"{{inputs.parameters.clusterName}}\"\n  annotations:\n    strimzi.io/node-pools: enabled\n    strimzi.io/kraft: enabled\nspec:\n  kafka:\n    version: 3.9.0\n    metadataVersion: 3.9-IV0\n    readinessProbe:\n      initialDelaySeconds: 1\n      periodSeconds: 2\n      timeoutSeconds: 2\n      failureThreshold: 1\n    livenessProbe:\n      initialDelaySeconds: 1\n      periodSeconds: 2\n      timeoutSeconds: 2\n      failureThreshold: 2\n    listeners:\n      - name: plain\n        port: 9092\n        type: internal\n        tls: false\n      - name: tls\n        port: 9093\n        type: internal\n        tls: true\n    config:\n      auto.create.topics.enable: false\n      offsets.topic.replication.factor: 1\n      transaction.state.log.replication.factor: 1\n      transaction.state.log.min.isr: 1\n      default.replication.factor: 1\n      min.insync.replicas: 1\n  entityOperator:\n    topicOperator: {}\n    userOperator: {}\n",
          "action": "apply",
          "setOwnerReference": true,
          "successCondition": "status.listeners"
        },
        "outputs": {
          "parameters": [
            {
              "name": "brokers",
              "valueFrom": {
                "jsonPath": "{.status.listeners[?(@.name=='plain')].bootstrapServers}"
              }
            }
          ]
        }
      },
      {
        "name": "deploykafkacluster",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            },
            {
              "name": "useKraft",
              "value": "true"
            }
          ]
        },
        "dag": {
          "tasks": [
            {
              "template": "deploykafkanodepool",
              "when": "{{inputs.parameters.useKraft}}",
              "arguments": {
                "parameters": [
                  {
                    "name": "clusterName",
                    "value": "{{inputs.parameters.clusterName}}"
                  }
                ]
              },
              "name": "deployPool"
            },
            {
              "template": "deploykafkaclusterkraft",
              "when": "{{inputs.parameters.useKraft}}",
              "arguments": {
                "parameters": [
                  {
                    "name": "clusterName",
                    "value": "{{inputs.parameters.clusterName}}"
                  }
                ]
              },
              "name": "deployKafkaClusterKraft"
            },
            {
              "template": "deploykafkaclusterzookeeper",
              "when": "!({{inputs.parameters.useKraft}})",
              "arguments": {
                "parameters": [
                  {
                    "name": "clusterName",
                    "value": "{{inputs.parameters.clusterName}}"
                  }
                ]
              },
              "name": "deployKafkaClusterZookeeper"
            }
          ]
        },
        "outputs": {
          "parameters": [
            {
              "name": "clusterName",
              "valueFrom": {
                "expression": "inputs.parameters.clusterName"
              }
            },
            {
              "name": "bootstrapServers",
              "valueFrom": {
                "expression": "(('Skipped' == tasks.deployKafkaClusterKraft.status) ? (tasks.deployKafkaClusterZookeeper.outputs.parameters.brokers) : (tasks.deployKafkaClusterKraft.outputs.parameters.brokers))"
              }
            }
          ]
        }
      },
      {
        "name": "createkafkatopic",
        "inputs": {
          "parameters": [
            {
              "name": "clusterName"
            },
            {
              "name": "topicName"
            },
            {
              "name": "topicPartitions"
            },
            {
              "name": "topicReplicas"
            }
          ]
        },
        "resource": {
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2\nkind: KafkaTopic\nmetadata:\n  name: \"{{inputs.parameters.topicName}}\"\n  labels:\n    strimzi.io/cluster: \"{{inputs.parameters.clusterName}}\"\nspec:\n  partitions: \"{{inputs.parameters.topicPartitions}}\"\n  replicas: \"{{inputs.parameters.topicReplicas}}\"\n  config:\n    retention.ms: 604800000\n    segment.bytes: 1073741824\n",
          "action": "apply",
          "setOwnerReference": true,
          "successCondition": "status.topicName"
        },
        "outputs": {
          "parameters": [
            {
              "name": "topicName",
              "valueFrom": {
                "jsonPath": "{.status.topicName}"
              }
            }
          ]
        }
      }
    ]
  }
}
