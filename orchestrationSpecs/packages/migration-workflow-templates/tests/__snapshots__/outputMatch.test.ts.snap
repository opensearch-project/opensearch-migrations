// Jest Snapshot v1, https://jestjs.io/docs/snapshot-testing

exports[`test workflow template renderings capture-proxy 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "capture-proxy",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [
            {
              "name": "serviceName",
            },
            {
              "name": "port",
            },
          ],
        },
        "name": "deployproxyservice",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sourceConfig",
            },
            {
              "name": "listenerPort",
            },
            {
              "name": "kafkaConnection",
            },
            {
              "name": "kafkaTopic",
            },
            {
              "name": "imageCaptureProxyLocation",
            },
            {
              "name": "imageCaptureProxyPullPolicy",
            },
          ],
        },
        "name": "deploycaptureproxy",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings capture-replay 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "capture-replay",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [
            {
              "name": "proxyEndpoint",
            },
          ],
        },
        "name": "idgenerator",
        "outputs": {
          "parameters": [
            {
              "name": "proxyEndpoint",
              "valueFrom": {
                "expression": "inputs.parameters.proxyEndpoint",
              },
            },
          ],
        },
        "steps": [
          [],
        ],
      },
      {
        "inputs": {
          "parameters": [],
        },
        "name": "getuserapproval",
        "outputs": {
          "parameters": [],
        },
        "suspend": {},
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "createdBootstrapServers",
            },
            {
              "name": "createdKafkaName",
            },
            {
              "name": "providedKafkaBootstrapServers",
            },
            {
              "name": "providedKafkaK8sName",
            },
          ],
        },
        "name": "getbrokerslist",
        "outputs": {
          "parameters": [
            {
              "name": "kafkaName",
              "valueFrom": {
                "expression": "((0 == len(inputs.parameters.providedKafkaK8sName)) ? (inputs.parameters.createdKafkaName) : (inputs.parameters.providedKafkaK8sName))",
              },
            },
            {
              "name": "bootstrapServers",
              "valueFrom": {
                "expression": "((0 == len(inputs.parameters.providedKafkaBootstrapServers)) ? (inputs.parameters.createdKafkaName) : (inputs.parameters.providedKafkaK8sName))",
              },
            },
          ],
        },
        "steps": [
          [],
        ],
      },
      {
        "dag": {
          "tasks": [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "proxyEndpoint",
                    "value": "{{='http://'+inputs.parameters.sessionName+':'+inputs.parameters.proxyListenPort}}",
                  },
                ],
              },
              "name": "idGenerator",
              "template": "idgenerator",
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "kafkaName",
                    "value": "{{=inputs.parameters.providedKafkaK8sName+'-'+last(split(tasks.idGenerator.id, '-'))}}",
                  },
                ],
              },
              "dependencies": [
                "idGenerator",
              ],
              "name": "kafkaClusterSetup",
              "templateRef": {
                "name": "setup-kafka",
                "template": "clusterdeploy",
              },
              "when": "{{=0 == len(inputs.parameters.providedKafkaBootstrapServers)}}",
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "createdBootstrapServers",
                    "value": "{{tasks.kafkaClusterSetup.outputs.parameters.bootstrapServers}}",
                  },
                  {
                    "name": "createdKafkaName",
                    "value": "{{tasks.kafkaClusterSetup.outputs.parameters.kafkaName}}",
                  },
                  {
                    "name": "providedKafkaBootstrapServers",
                    "value": "{{inputs.parameters.providedKafkaBootstrapServers}}",
                  },
                  {
                    "name": "providedKafkaK8sName",
                    "value": "{{inputs.parameters.providedKafkaK8sName}}",
                  },
                ],
              },
              "dependencies": [
                "kafkaClusterSetup",
              ],
              "name": "getBrokersList",
              "template": "getbrokerslist",
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "kafkaName",
                    "value": "{{tasks.getBrokersList.outputs.parameters.kafkaName}}",
                  },
                  {
                    "name": "topicName",
                    "value": "{{=((inputs.parameters.topicName == '') ? (inputs.parameters.sessionName) : (inputs.parameters.topicName))}}",
                  },
                  {
                    "name": "topicPartitions",
                    "value": "{{inputs.parameters.topicPartitions}}",
                  },
                  {
                    "name": "topicReplicas",
                    "value": "{{inputs.parameters.topicReplicas}}",
                  },
                ],
              },
              "dependencies": [
                "getBrokersList",
              ],
              "name": "kafkaTopicSetup",
              "templateRef": {
                "name": "setup-kafka",
                "template": "createkafkatopic",
              },
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "imageCaptureProxyLocation",
                    "value": "{{inputs.parameters.imageCaptureProxyLocation}}",
                  },
                  {
                    "name": "imageCaptureProxyPullPolicy",
                    "value": "{{inputs.parameters.imageCaptureProxyPullPolicy}}",
                  },
                  {
                    "name": "listenerPort",
                    "value": "{{inputs.parameters.proxyListenPort}}",
                  },
                  {
                    "name": "kafkaConnection",
                    "value": "{{tasks.getBrokersList.outputs.parameters.bootstrapServers}}",
                  },
                  {
                    "name": "kafkaTopic",
                    "value": "{{tasks.kafkaTopicSetup.outputs.parameters.topicName}}",
                  },
                ],
              },
              "dependencies": [
                "getBrokersList",
                "kafkaTopicSetup",
              ],
              "name": "deployCaptureProxy",
              "templateRef": {
                "name": "capture-proxy",
                "template": "deploycaptureproxy",
              },
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "serviceName",
                    "value": "{{inputs.parameters.sessionName}}",
                  },
                  {
                    "name": "port",
                    "value": "{{inputs.parameters.proxyListenPort}}",
                  },
                ],
              },
              "dependencies": [
                "deployCaptureProxy",
              ],
              "name": "proxyService",
              "templateRef": {
                "name": "capture-proxy",
                "template": "deployproxyservice",
              },
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "replayerConfig",
                    "value": "{{inputs.parameters.replayerConfig}}",
                  },
                  {
                    "name": "imageTrafficReplayerLocation",
                    "value": "{{inputs.parameters.imageTrafficReplayerLocation}}",
                  },
                  {
                    "name": "imageTrafficReplayerPullPolicy",
                    "value": "{{inputs.parameters.imageTrafficReplayerPullPolicy}}",
                  },
                  {
                    "name": "kafkaTrafficBrokers",
                    "value": "{{tasks.getBrokersList.outputs.parameters.bootstrapServers}}",
                  },
                  {
                    "name": "kafkaTrafficTopic",
                    "value": "{{tasks.kafkaTopicSetup.outputs.parameters.topicName}}",
                  },
                  {
                    "name": "kafkaGroupId",
                    "value": "{{tasks.idGenerator.id}}",
                  },
                ],
              },
              "dependencies": [
                "getBrokersList",
                "kafkaTopicSetup",
              ],
              "name": "Replayer",
              "templateRef": {
                "name": "replayer",
                "template": "createdeploymentfromconfig",
              },
            },
          ],
        },
        "inputs": {
          "parameters": [
            {
              "name": "sessionName",
            },
            {
              "name": "sourceConfig",
            },
            {
              "name": "proxyDestination",
            },
            {
              "name": "proxyListenPort",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "replayerConfig",
            },
            {
              "name": "providedKafkaBootstrapServers",
              "value": "",
            },
            {
              "name": "providedKafkaK8sName",
              "value": "",
            },
            {
              "name": "kafkaPrefix",
              "value": "capturetraffic",
            },
            {
              "name": "topicName",
              "value": "",
            },
            {
              "name": "topicPartitions",
              "value": "0",
            },
            {
              "name": "topicReplicas",
              "value": "0",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
            {
              "name": "imageTrafficReplayerLocation",
            },
            {
              "name": "imageTrafficReplayerPullPolicy",
            },
            {
              "name": "imageCaptureProxyLocation",
            },
            {
              "name": "imageCaptureProxyPullPolicy",
            },
          ],
        },
        "name": "runall",
        "outputs": {
          "parameters": [],
        },
      },
    ],
  },
}
`;

exports[`test workflow template renderings create-or-get-snapshot 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "create-or-get-snapshot",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [
            {
              "name": "sourceLabel",
            },
            {
              "name": "snapshotNameConfig",
            },
            {
              "name": "uniqueRunNonce",
            },
          ],
        },
        "name": "getsnapshotname",
        "outputs": {
          "parameters": [
            {
              "name": "snapshotName",
              "valueFrom": {
                "expression": "(('snapshotNamePrefix' in fromJSON(inputs.parameters.snapshotNameConfig)) ? (inputs.parameters.sourceLabel + '_' + fromJSON(inputs.parameters.snapshotNameConfig)['snapshotNamePrefix'] + '_' + inputs.parameters.uniqueRunNonce) : (fromJSON(inputs.parameters.snapshotNameConfig)['externallyManagedSnapshot']))",
              },
            },
            {
              "name": "autoCreate",
              "valueFrom": {
                "expression": "'snapshotNamePrefix' in fromJSON(inputs.parameters.snapshotNameConfig)",
              },
            },
          ],
        },
        "steps": [
          [],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "createSnapshotConfig",
            },
            {
              "name": "sourceConfig",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "targetLabel",
            },
            {
              "name": "uniqueRunNonce",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "createorgetsnapshot",
        "outputs": {
          "parameters": [
            {
              "name": "snapshotConfig",
              "valueFrom": {
                "expression": "toJSON(sprig.dict("snapshotName", steps.getSnapshotName.outputs.parameters.snapshotName, "repoConfig", fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], "label", fromJSON(inputs.parameters.snapshotConfig)['label']))",
              },
            },
          ],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "uniqueRunNonce",
                    "value": "{{inputs.parameters.uniqueRunNonce}}",
                  },
                  {
                    "name": "sourceLabel",
                    "value": "{{=fromJSON(inputs.parameters.sourceConfig)['label']}}",
                  },
                  {
                    "name": "snapshotNameConfig",
                    "value": "{{=toJSON(fromJSON(inputs.parameters.snapshotConfig)['snapshotNameConfig'])}}",
                  },
                ],
              },
              "name": "getSnapshotName",
              "template": "getsnapshotname",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{=toJSON(sprig.dict("repoConfig", jsonpath(inputs.parameters.snapshotConfig, '$.repoConfig'), "snapshotName", lower(steps.getSnapshotName.outputs.parameters.snapshotName), "label", jsonpath(inputs.parameters.snapshotConfig, '$.label')))}}",
                  },
                  {
                    "name": "createSnapshotConfig",
                    "value": "{{inputs.parameters.createSnapshotConfig}}",
                  },
                  {
                    "name": "targetLabel",
                    "value": "{{inputs.parameters.targetLabel}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                ],
              },
              "name": "createSnapshot",
              "templateRef": {
                "name": "create-snapshot",
                "template": "snapshotworkflow",
              },
              "when": "{{steps.getSnapshotName.outputs.parameters.autoCreate}}",
            },
          ],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings create-snapshot 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "create-snapshot",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "container": {
          "args": [
            "---INLINE-JSON",
            "{{=toJSON(sprig.merge(sprig.merge(sprig.merge(sprig.merge((('authConfig' in fromJSON(inputs.parameters.sourceConfig)) ? ((('sigv4' in fromJSON(inputs.parameters.sourceConfig)['authConfig']) ? (sprig.dict("sourceAwsServiceSigningName", fromJSON(inputs.parameters.sourceConfig)['authConfig']['sigv4']['service'], "sourceAwsRegion", fromJSON(inputs.parameters.sourceConfig)['authConfig']['sigv4']['region'])) : ((('mtls' in fromJSON(inputs.parameters.sourceConfig)['authConfig']) ? (sprig.dict("sourceCaCert", fromJSON(inputs.parameters.sourceConfig)['authConfig']['mtls']['caCert'])) : ({}))))) : ({})), (('endpoint' in fromJSON(inputs.parameters.sourceConfig)) ? (sprig.dict("sourceHost", fromJSON(inputs.parameters.sourceConfig)['endpoint'])) : ({}))), sprig.dict("sourceInsecure", sprig.dig('allowInsecure', false, fromJSON(inputs.parameters.sourceConfig)))), sprig.merge(sprig.omit(fromJSON(inputs.parameters.createSnapshotConfig), 'loggingConfigurationOverrideConfigMap', 'semaphoreConfigMapName', 'semaphoreKey'), sprig.dict("noWait", true))), sprig.merge(sprig.dict("snapshotName", fromJSON(inputs.parameters.snapshotConfig)['snapshotName'], "snapshotRepoName", jsonpath(inputs.parameters.snapshotConfig, '$.repoConfig.repoName')), sprig.merge(sprig.merge(((0 == len(sprig.dig('endpoint', '', fromJSON(inputs.parameters.snapshotConfig)['repoConfig']))) ? (sprig.dict()) : (sprig.dict("s3Endpoint", fromJSON(inputs.parameters.snapshotConfig)['repoConfig']['endpoint']))), ((0 == len(sprig.dig('s3RoleArn', '', fromJSON(inputs.parameters.snapshotConfig)['repoConfig']))) ? (sprig.dict()) : (sprig.dict("s3RoleArn", fromJSON(inputs.parameters.snapshotConfig)['repoConfig']['s3RoleArn'])))), sprig.dict("s3RepoUri", fromJSON(inputs.parameters.snapshotConfig)['repoConfig']['s3RepoPathUri'], "s3Region", fromJSON(inputs.parameters.snapshotConfig)['repoConfig']['awsRegion'])))))}}",
          ],
          "command": [
            "/root/createSnapshot/bin/CreateSnapshot",
          ],
          "env": [
            {
              "name": "SOURCE_USERNAME",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "username",
                  "name": "{{=((0 == len(sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.sourceConfig)))) ? ('empty') : (sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.sourceConfig))))}}",
                  "optional": true,
                },
              },
            },
            {
              "name": "SOURCE_PASSWORD",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "password",
                  "name": "{{=((0 == len(sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.sourceConfig)))) ? ('empty') : (sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.sourceConfig))))}}",
                  "optional": true,
                },
              },
            },
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "sourceConfig",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "createSnapshotConfig",
            },
            {
              "name": "sourceK8sLabel",
            },
            {
              "name": "targetK8sLabel",
            },
            {
              "name": "snapshotK8sLabel",
            },
            {
              "name": "taskK8sLabel",
              "value": "snapshot",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "metadata": {
          "labels": {
            "migrations.opensearch.org/snapshot": "{{inputs.parameters.snapshotK8sLabel}}",
            "migrations.opensearch.org/source": "{{inputs.parameters.sourceK8sLabel}}",
            "migrations.opensearch.org/target": "{{inputs.parameters.targetK8sLabel}}",
            "migrations.opensearch.org/task": "{{inputs.parameters.taskK8sLabel}}",
          },
        },
        "name": "runcreatesnapshot",
        "outputs": {
          "parameters": [],
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "configContents",
            },
            {
              "name": "sourceK8sLabel",
            },
            {
              "name": "targetK8sLabel",
            },
            {
              "name": "snapshotK8sLabel",
            },
            {
              "name": "taskK8sLabel",
              "value": "snapshotStatusCheck",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "checksnapshotstatusinternal",
        "outputs": {
          "parameters": [],
        },
        "retryStrategy": {
          "backoff": {
            "cap": "300",
            "duration": "5",
            "factor": "2",
          },
          "limit": "200",
          "retryPolicy": "Always",
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "configContents",
                    "value": "{{inputs.parameters.configContents}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceK8sLabel}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{inputs.parameters.targetK8sLabel}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{inputs.parameters.snapshotK8sLabel}}",
                  },
                  {
                    "name": "taskK8sLabel",
                    "value": "{{inputs.parameters.taskK8sLabel}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "command",
                    "value": "set -e
  touch /tmp/status-output.txt
  touch /tmp/phase-output.txt
  
  # Quick status check - if SUCCESS, we're done
  status=$(console --config-file=/config/migration_services.yaml snapshot status)
  if [ "$status" = "SUCCESS" ]; then
    echo "Snapshot completed successfully" > /tmp/status-output.txt
    exit 0
  fi
  
  # Deep check and save output in case there was a race condition
  deep_output=$(console --config-file=/config/migration_services.yaml snapshot status --deep-check)
  
  # Check if deep check also returned SUCCESS (snapshot completed during execution)
  if [ "$deep_output" = "SUCCESS" ]; then
    echo "Snapshot completed successfully" > /tmp/status-output.txt
    exit 0
  fi
  
  # Process deep check output with awk for in-progress snapshots
  echo "$deep_output" | awk '
    /Total shards:/ { total = $3 }
    /Successful shards:/ { successful = $3 }
    /Data processed:/ { data = $3; unit = $4 }
    /Estimated time to completion:/ { 
      sub(/.*: /, "");
      eta = $0
    }
    END {
      if (total) {
        output = "Shards: " successful "/" total " | Data: " data " " unit
        if (eta != "0h 0m 0s") {
          output = output " | ETA: " eta
        }
        print output
      }
    }
  ' > /tmp/status-output.txt
  echo Checked > /tmp/phase-output.txt
  
  exit 1",
                  },
                ],
              },
              "name": "checkSnapshotCompletion",
              "templateRef": {
                "name": "migration-console",
                "template": "runmigrationcommandforstatus",
              },
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "configContents",
            },
            {
              "name": "sourceK8sLabel",
            },
            {
              "name": "targetK8sLabel",
            },
            {
              "name": "snapshotK8sLabel",
            },
            {
              "name": "groupName",
              "value": "checks",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "checksnapshotstatus",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "configContents",
                    "value": "{{inputs.parameters.configContents}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceK8sLabel}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{inputs.parameters.targetK8sLabel}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{inputs.parameters.snapshotK8sLabel}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                ],
              },
              "name": "runStatusChecks",
              "template": "checksnapshotstatusinternal",
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sourceConfig",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "createSnapshotConfig",
            },
            {
              "name": "targetLabel",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "snapshotworkflow",
        "outputs": {
          "parameters": [
            {
              "name": "snapshotConfig",
              "valueFrom": {
                "expression": "inputs.parameters.snapshotConfig",
              },
            },
          ],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "createSnapshotConfig",
                    "value": "{{inputs.parameters.createSnapshotConfig}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.sourceConfig, '$.label')}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{inputs.parameters.targetLabel}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}",
                  },
                ],
              },
              "name": "createSnapshot",
              "template": "runcreatesnapshot",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                ],
              },
              "name": "getConsoleConfig",
              "templateRef": {
                "name": "migration-console",
                "template": "getconsoleconfig",
              },
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "configContents",
                    "value": "{{steps.getConsoleConfig.outputs.parameters.configContents}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.sourceConfig, '$.label')}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{inputs.parameters.targetLabel}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}",
                  },
                ],
              },
              "name": "waitForCompletion",
              "template": "checksnapshotstatus",
            },
          ],
        ],
        "synchronization": {
          "semaphores": [
            {
              "configMapKeyRef": {
                "key": "{{=fromJSON(inputs.parameters.createSnapshotConfig)['semaphoreKey']}}",
                "name": "{{=fromJSON(inputs.parameters.createSnapshotConfig)['semaphoreConfigMapName']}}",
              },
            },
          ],
        },
      },
    ],
  },
}
`;

exports[`test workflow template renderings document-bulk-load 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "document-bulk-load",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [
            {
              "name": "sessionName",
            },
          ],
        },
        "name": "stophistoricalbackfill",
        "outputs": {
          "parameters": [],
        },
        "resource": {
          "action": "delete",
          "flags": [
            "--ignore-not-found",
          ],
          "manifest": "apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{=inputs.parameters.sessionName+'-rfs'}}"
",
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "configContents",
            },
            {
              "name": "sessionName",
            },
            {
              "name": "sourceK8sLabel",
            },
            {
              "name": "targetK8sLabel",
            },
            {
              "name": "snapshotK8sLabel",
            },
            {
              "name": "fromSnapshotMigrationK8sLabel",
            },
            {
              "name": "taskK8sLabel",
              "value": "reindexFromSnapshotStatusCheck",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "waitforcompletioninternal",
        "outputs": {
          "parameters": [],
        },
        "retryStrategy": {
          "backoff": {
            "cap": "300",
            "duration": "5",
            "factor": "2",
          },
          "limit": "200",
          "retryPolicy": "Always",
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "configContents",
                    "value": "{{inputs.parameters.configContents}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceK8sLabel}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{inputs.parameters.targetK8sLabel}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{inputs.parameters.snapshotK8sLabel}}",
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.fromSnapshotMigrationK8sLabel}}",
                  },
                  {
                    "name": "taskK8sLabel",
                    "value": "{{inputs.parameters.taskK8sLabel}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "command",
                    "value": "
set -e -x
touch /tmp/status-output.txt
touch /tmp/phase-output.txt

status=$(console --config-file=/config/migration_services.yaml backfill status --deep-check)

# Check if initializing
if [[ "$status" == "Shards are initializing" ]]; then
    echo "Shards are initializing" > /tmp/status-output.txt
else
    # Format detailed status
    echo "$status" | awk '
    /^Backfill status:/ { status = $3 }
    /^Backfill percentage_completed:/ { pct = $3 }
    /^Backfill eta_ms:/ { eta = $3 }
    /^Backfill shard_total:/ { total = $3 }
    /^Backfill shard_complete:/ { complete = $3 }
    /^Backfill shard_in_progress:/ { progress = $3 }
    /^Backfill shard_waiting:/ { waiting = $3 }

    END {
        gsub(/^[^.]+\\./, "", status)
        eta_str = (eta == "" || eta == "None") ? "unknown" : int(eta/1000) "s"
        printf "complete: %.2f%%, ETA: %s; shards in-progress: %d; remaining: %d; shards complete/total: %d/%d\\n", 
               pct, eta_str, progress, waiting, complete, total
    }
    ' > /tmp/status-output.txt
fi

# Check completion status - exit 0 only if complete, otherwise exit 1
echo "$status" | awk '
/^Backfill shard_total:/ {total=$3} 
/^Backfill shard_complete:/ {complete=$3} 
END {
  if(total > 0 && total==complete) {
    exit 0
  } else {
    exit 1
  }
}' || (echo Checked > /tmp/phase-output.txt && exit 1)
",
                  },
                ],
              },
              "name": "checkBackfillStatus",
              "templateRef": {
                "name": "migration-console",
                "template": "runmigrationcommandforstatus",
              },
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "configContents",
            },
            {
              "name": "sessionName",
            },
            {
              "name": "sourceK8sLabel",
            },
            {
              "name": "targetK8sLabel",
            },
            {
              "name": "snapshotK8sLabel",
            },
            {
              "name": "fromSnapshotMigrationK8sLabel",
            },
            {
              "name": "groupName",
              "value": "checks",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "waitforcompletion",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "configContents",
                    "value": "{{inputs.parameters.configContents}}",
                  },
                  {
                    "name": "sessionName",
                    "value": "{{inputs.parameters.sessionName}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceK8sLabel}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{inputs.parameters.targetK8sLabel}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{inputs.parameters.snapshotK8sLabel}}",
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.fromSnapshotMigrationK8sLabel}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                ],
              },
              "name": "runStatusChecks",
              "template": "waitforcompletioninternal",
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sessionName",
            },
            {
              "name": "rfsJsonConfig",
            },
            {
              "name": "basicCredsSecretNameOrEmpty",
            },
            {
              "name": "podReplicas",
            },
            {
              "name": "loggingConfigurationOverrideConfigMap",
            },
            {
              "description": "Only used for local testing",
              "name": "useLocalStack",
            },
            {
              "name": "resources",
            },
            {
              "name": "sourceK8sLabel",
            },
            {
              "name": "targetK8sLabel",
            },
            {
              "name": "snapshotK8sLabel",
            },
            {
              "name": "fromSnapshotMigrationK8sLabel",
            },
            {
              "name": "taskK8sLabel",
              "value": "reindexFromSnapshot",
            },
            {
              "name": "imageReindexFromSnapshotLocation",
            },
            {
              "name": "imageReindexFromSnapshotPullPolicy",
            },
          ],
        },
        "name": "starthistoricalbackfill",
        "outputs": {
          "parameters": [],
        },
        "resource": {
          "action": "create",
          "manifest": "apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{=inputs.parameters.sessionName+'-rfs'}}"
  labels:
    workflows.argoproj.io/workflow: "{{workflow.name}}"
    migrations.opensearch.org/source: "{{inputs.parameters.sourceK8sLabel}}"
    migrations.opensearch.org/target: "{{inputs.parameters.targetK8sLabel}}"
    migrations.opensearch.org/snapshot: "{{inputs.parameters.snapshotK8sLabel}}"
    migrations.opensearch.org/from-snapshot-migration: "{{inputs.parameters.fromSnapshotMigrationK8sLabel}}"
    migrations.opensearch.org/task: "{{inputs.parameters.taskK8sLabel}}"
spec:
  replicas: {{=fromJSON(inputs.parameters.podReplicas)}}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: bulk-loader
      deployment-name: "{{=inputs.parameters.sessionName+'-rfs'}}"
  template:
    metadata:
      labels:
        app: bulk-loader
        deployment-name: "{{=inputs.parameters.sessionName+'-rfs'}}"
        workflows.argoproj.io/workflow: "{{workflow.name}}"
        migrations.opensearch.org/source: "{{inputs.parameters.sourceK8sLabel}}"
        migrations.opensearch.org/target: "{{inputs.parameters.targetK8sLabel}}"
        migrations.opensearch.org/snapshot: "{{inputs.parameters.snapshotK8sLabel}}"
        migrations.opensearch.org/from-snapshot-migration: "{{inputs.parameters.fromSnapshotMigrationK8sLabel}}"
        migrations.opensearch.org/task: "{{inputs.parameters.taskK8sLabel}}"
    spec:
      serviceAccountName: argo-workflow-executor
      containers:
        - name: bulk-loader
          image: "{{inputs.parameters.imageReindexFromSnapshotLocation}}"
          imagePullPolicy: "{{inputs.parameters.imageReindexFromSnapshotPullPolicy}}"
          command:
            - /rfs-app/runJavaWithClasspathWithRepeat.sh
          args:
            - org.opensearch.migrations.RfsMigrateDocuments
            - ---INLINE-JSON
            - "{{=toBase64(inputs.parameters.rfsJsonConfig)}}"
          resources: {{=fromJSON(inputs.parameters.resources)}}
          env:
            - name: TARGET_USERNAME
              valueFrom:
                secretKeyRef:
                  name: "{{=((0 == len(inputs.parameters.basicCredsSecretNameOrEmpty)) ? ('empty') : (inputs.parameters.basicCredsSecretNameOrEmpty))}}"
                  key: username
                  optional: true
            - name: TARGET_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "{{=((0 == len(inputs.parameters.basicCredsSecretNameOrEmpty)) ? ('empty') : (inputs.parameters.basicCredsSecretNameOrEmpty))}}"
                  key: password
                  optional: true
            - name: FAILED_REQUESTS_LOGGER_LEVEL
              value: "OFF"
            - name: CONSOLE_LOG_FORMAT
              value: json
            - name: JAVA_OPTS
              value: "{{=' ' + ' ' + ((!(0 == len(inputs.parameters.loggingConfigurationOverrideConfigMap))) ? ('-Dlog4j2.configurationFile=/config/logConfiguration') : (''))}}"
            - name: AWS_SHARED_CREDENTIALS_FILE
              value: "{{=((fromJSON(inputs.parameters.useLocalStack)) ? ('/config/credentials/configuration') : (''))}}"
          volumeMounts:
            - name: log4j-configuration
              mountPath: /config/logConfiguration
              readOnly: true
            - name: localstack-test-creds
              mountPath: /config/credentials
              readOnly: true
      volumes:
        - name: log4j-configuration
          configMap:
            name: "{{=((0 == len(inputs.parameters.loggingConfigurationOverrideConfigMap)) ? ('default-log4j-config') : (inputs.parameters.loggingConfigurationOverrideConfigMap))}}"
            optional: {{=!(!(0 == len(inputs.parameters.loggingConfigurationOverrideConfigMap)))}}
        - name: localstack-test-creds
          configMap:
            name: localstack-test-creds
            optional: {{=!(fromJSON(inputs.parameters.useLocalStack))}}
",
          "setOwnerReference": true,
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sessionName",
            },
            {
              "name": "sourceVersion",
            },
            {
              "name": "sourceLabel",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "documentBackfillConfig",
            },
            {
              "name": "migrationLabel",
            },
            {
              "name": "imageReindexFromSnapshotLocation",
            },
            {
              "name": "imageReindexFromSnapshotPullPolicy",
            },
          ],
        },
        "name": "starthistoricalbackfillfromconfig",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sessionName",
                    "value": "{{inputs.parameters.sessionName}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotLocation",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotLocation}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotPullPolicy",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotPullPolicy}}",
                  },
                  {
                    "name": "podReplicas",
                    "value": "{{=sprig.dig('podReplicas', 1, fromJSON(inputs.parameters.documentBackfillConfig))}}",
                  },
                  {
                    "name": "basicCredsSecretNameOrEmpty",
                    "value": "{{=sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig))}}",
                  },
                  {
                    "name": "loggingConfigurationOverrideConfigMap",
                    "value": "{{=sprig.dig('loggingConfigurationOverrideConfigMap', '', fromJSON(inputs.parameters.documentBackfillConfig))}}",
                  },
                  {
                    "name": "useLocalStack",
                    "value": "{{=sprig.dig('repoConfig', 'useLocalStack', false, fromJSON(inputs.parameters.snapshotConfig))}}",
                  },
                  {
                    "name": "rfsJsonConfig",
                    "value": "{{=toJSON(sprig.merge(sprig.merge(sprig.merge(sprig.merge((('authConfig' in fromJSON(inputs.parameters.targetConfig)) ? ((('sigv4' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict("targetAwsServiceSigningName", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['service'], "targetAwsRegion", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['region'])) : ((('mtls' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict("targetCaCert", fromJSON(inputs.parameters.targetConfig)['authConfig']['mtls']['caCert'])) : ({}))))) : ({})), (('endpoint' in fromJSON(inputs.parameters.targetConfig)) ? (sprig.dict("targetHost", fromJSON(inputs.parameters.targetConfig)['endpoint'])) : ({}))), sprig.dict("targetInsecure", sprig.dig('allowInsecure', false, fromJSON(inputs.parameters.targetConfig)))), sprig.omit(fromJSON(inputs.parameters.documentBackfillConfig), 'loggingConfigurationOverrideConfigMap', 'podReplicas', 'resources')), sprig.merge(sprig.dict("snapshotName", fromJSON(inputs.parameters.snapshotConfig)['snapshotName'], "sourceVersion", inputs.parameters.sourceVersion, "sessionName", inputs.parameters.sessionName, "luceneDir", '/tmp', "cleanLocalDirs", true), sprig.merge(sprig.merge(((0 == len(sprig.dig('endpoint', '', sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')))) ? (sprig.dict()) : (sprig.dict("s3Endpoint", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['endpoint']))), ((0 == len(sprig.dig('s3RoleArn', '', sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')))) ? (sprig.dict()) : (sprig.dict("s3RoleArn", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['s3RoleArn'])))), sprig.dict("s3RepoUri", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['s3RepoPathUri'], "s3Region", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['awsRegion'], "s3LocalDir", '/tmp')))))}}",
                  },
                  {
                    "name": "resources",
                    "value": "{{=toJSON(jsonpath(inputs.parameters.documentBackfillConfig, '$.resources'))}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceLabel}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.targetConfig, '$.label')}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}",
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.migrationLabel}}",
                  },
                ],
              },
              "name": "startHistoricalBackfill",
              "template": "starthistoricalbackfill",
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sourceVersion",
            },
            {
              "name": "sourceLabel",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "sessionName",
            },
            {
              "name": "indices",
              "value": "[]",
            },
            {
              "name": "documentBackfillConfig",
            },
            {
              "name": "migrationLabel",
            },
            {
              "name": "imageReindexFromSnapshotLocation",
            },
            {
              "name": "imageReindexFromSnapshotPullPolicy",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "runbulkload",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sessionName",
                    "value": "{{inputs.parameters.sessionName}}",
                  },
                  {
                    "name": "sourceVersion",
                    "value": "{{inputs.parameters.sourceVersion}}",
                  },
                  {
                    "name": "sourceLabel",
                    "value": "{{inputs.parameters.sourceLabel}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "documentBackfillConfig",
                    "value": "{{inputs.parameters.documentBackfillConfig}}",
                  },
                  {
                    "name": "migrationLabel",
                    "value": "{{inputs.parameters.migrationLabel}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotLocation",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotLocation}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotPullPolicy",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotPullPolicy}}",
                  },
                ],
              },
              "name": "startHistoricalBackfillFromConfig",
              "template": "starthistoricalbackfillfromconfig",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "backfillSession",
                    "value": "{{=toJSON(sprig.dict("sessionName", inputs.parameters.sessionName, "deploymentName", inputs.parameters.sessionName+'-rfs'))}}",
                  },
                ],
              },
              "name": "setupWaitForCompletion",
              "templateRef": {
                "name": "migration-console",
                "template": "getconsoleconfig",
              },
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sessionName",
                    "value": "{{inputs.parameters.sessionName}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "configContents",
                    "value": "{{steps.setupWaitForCompletion.outputs.parameters.configContents}}",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{inputs.parameters.sourceLabel}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.targetConfig, '$.label')}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}",
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.migrationLabel}}",
                  },
                ],
              },
              "name": "waitForCompletion",
              "template": "waitforcompletion",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sessionName",
                    "value": "{{inputs.parameters.sessionName}}",
                  },
                ],
              },
              "name": "stopHistoricalBackfill",
              "template": "stophistoricalbackfill",
            },
          ],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings full-migration 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "full-migration",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": "main",
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [],
        },
        "name": "donothing",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [],
        ],
      },
      {
        "container": {
          "args": [
            "echo runReplayerForTarget",
          ],
          "command": [
            "sh",
            "-c",
          ],
          "env": [],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "targetConfig",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "runreplayerfortarget",
        "outputs": {
          "parameters": [],
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sourceConfig",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "migrationLabel",
            },
            {
              "name": "groupName",
            },
            {
              "name": "metadataMigrationConfig",
              "value": "",
            },
            {
              "name": "documentBackfillConfig",
              "value": "",
            },
            {
              "description": "Workflow session nonce",
              "name": "uniqueRunNonce",
            },
            {
              "name": "imageCaptureProxyLocation",
            },
            {
              "name": "imageCaptureProxyPullPolicy",
            },
            {
              "name": "imageTrafficReplayerLocation",
            },
            {
              "name": "imageTrafficReplayerPullPolicy",
            },
            {
              "name": "imageReindexFromSnapshotLocation",
            },
            {
              "name": "imageReindexFromSnapshotPullPolicy",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "migratefromsnapshot",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [],
              },
              "name": "idGenerator",
              "template": "donothing",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "metadataMigrationConfig",
                    "value": "{{inputs.parameters.metadataMigrationConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "migrationLabel",
                    "value": "{{inputs.parameters.migrationLabel}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                ],
              },
              "name": "metadataMigrate",
              "templateRef": {
                "name": "metadata-migration",
                "template": "migratemetadata",
              },
              "when": "{{=!(0 == len(inputs.parameters.metadataMigrationConfig))}}",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "documentBackfillConfig",
                    "value": "{{inputs.parameters.documentBackfillConfig}}",
                  },
                  {
                    "name": "migrationLabel",
                    "value": "{{inputs.parameters.migrationLabel}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotLocation",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotLocation}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotPullPolicy",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotPullPolicy}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "sessionName",
                    "value": "{{steps.idGenerator.id}}",
                  },
                  {
                    "name": "sourceVersion",
                    "value": "{{=jsonpath(inputs.parameters.sourceConfig, '$.version')}}",
                  },
                  {
                    "name": "sourceLabel",
                    "value": "{{=jsonpath(inputs.parameters.sourceConfig, '$.label')}}",
                  },
                ],
              },
              "name": "bulkLoadDocuments",
              "templateRef": {
                "name": "document-bulk-load",
                "template": "runbulkload",
              },
              "when": "{{=!(0 == len(inputs.parameters.documentBackfillConfig))}}",
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sourceConfig",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "migrations",
            },
            {
              "name": "groupName",
            },
            {
              "name": "createSnapshotConfig",
              "value": "",
            },
            {
              "name": "uniqueRunNonce",
            },
            {
              "name": "imageCaptureProxyLocation",
            },
            {
              "name": "imageCaptureProxyPullPolicy",
            },
            {
              "name": "imageTrafficReplayerLocation",
            },
            {
              "name": "imageTrafficReplayerPullPolicy",
            },
            {
              "name": "imageReindexFromSnapshotLocation",
            },
            {
              "name": "imageReindexFromSnapshotPullPolicy",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "getsnapshotthenmigratesnapshot",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "createSnapshotConfig",
                    "value": "{{inputs.parameters.createSnapshotConfig}}",
                  },
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "uniqueRunNonce",
                    "value": "{{inputs.parameters.uniqueRunNonce}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "targetLabel",
                    "value": "{{=jsonpath(inputs.parameters.targetConfig, '$.label')}}",
                  },
                ],
              },
              "name": "createOrGetSnapshot",
              "templateRef": {
                "name": "create-or-get-snapshot",
                "template": "createorgetsnapshot",
              },
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "uniqueRunNonce",
                    "value": "{{inputs.parameters.uniqueRunNonce}}",
                  },
                  {
                    "name": "imageCaptureProxyLocation",
                    "value": "{{inputs.parameters.imageCaptureProxyLocation}}",
                  },
                  {
                    "name": "imageCaptureProxyPullPolicy",
                    "value": "{{inputs.parameters.imageCaptureProxyPullPolicy}}",
                  },
                  {
                    "name": "imageTrafficReplayerLocation",
                    "value": "{{inputs.parameters.imageTrafficReplayerLocation}}",
                  },
                  {
                    "name": "imageTrafficReplayerPullPolicy",
                    "value": "{{inputs.parameters.imageTrafficReplayerPullPolicy}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotLocation",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotLocation}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotPullPolicy",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotPullPolicy}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "label",
                    "value": "{{=jsonpath(toJSON(item), '$.label')}}",
                  },
                  {
                    "name": "metadataMigrationConfig",
                    "value": "{{=sprig.dig('metadataMigrationConfig', '', item)}}",
                  },
                  {
                    "name": "documentBackfillConfig",
                    "value": "{{=sprig.dig('documentBackfillConfig', '', item)}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{steps.createOrGetSnapshot.outputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "migrationLabel",
                    "value": "{{=item['label']}}",
                  },
                  {
                    "name": "groupName",
                    "value": "{{=item['label']}}",
                  },
                ],
              },
              "name": "migrateFromSnapshot",
              "template": "migratefromsnapshot",
              "withParam": "{{inputs.parameters.migrations}}",
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "sourceConfig",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "groupName",
              "value": "{{=fromJSON(inputs.parameters.sourceConfig)['label']+' to '+fromJSON(inputs.parameters.targetConfig)['label']}}",
            },
            {
              "name": "snapshotExtractAndLoadConfigArray",
              "value": "",
            },
            {
              "name": "replayerConfig",
              "value": "",
            },
            {
              "name": "uniqueRunNonce",
            },
            {
              "name": "imageCaptureProxyLocation",
            },
            {
              "name": "imageCaptureProxyPullPolicy",
            },
            {
              "name": "imageTrafficReplayerLocation",
            },
            {
              "name": "imageTrafficReplayerPullPolicy",
            },
            {
              "name": "imageReindexFromSnapshotLocation",
            },
            {
              "name": "imageReindexFromSnapshotPullPolicy",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "migration",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "uniqueRunNonce",
                    "value": "{{inputs.parameters.uniqueRunNonce}}",
                  },
                  {
                    "name": "imageCaptureProxyLocation",
                    "value": "{{inputs.parameters.imageCaptureProxyLocation}}",
                  },
                  {
                    "name": "imageCaptureProxyPullPolicy",
                    "value": "{{inputs.parameters.imageCaptureProxyPullPolicy}}",
                  },
                  {
                    "name": "imageTrafficReplayerLocation",
                    "value": "{{inputs.parameters.imageTrafficReplayerLocation}}",
                  },
                  {
                    "name": "imageTrafficReplayerPullPolicy",
                    "value": "{{inputs.parameters.imageTrafficReplayerPullPolicy}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotLocation",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotLocation}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotPullPolicy",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotPullPolicy}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "createSnapshotConfig",
                    "value": "{{=sprig.dig('createSnapshotConfig', '', item)}}",
                  },
                  {
                    "name": "migrations",
                    "value": "{{=jsonpath(toJSON(item), '$.migrations')}}",
                  },
                  {
                    "name": "label",
                    "value": "{{=jsonpath(toJSON(item), '$.label')}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{=jsonpath(toJSON(item), '$.snapshotConfig')}}",
                  },
                  {
                    "name": "groupName",
                    "value": "{{=item['label']}}",
                  },
                ],
              },
              "name": "getSnapshotThenMigrateSnapshot",
              "template": "getsnapshotthenmigratesnapshot",
              "when": "{{=!(0 == len(inputs.parameters.snapshotExtractAndLoadConfigArray))}}",
              "withParam": "{{inputs.parameters.snapshotExtractAndLoadConfigArray}}",
            },
          ],
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "description": "List of server configurations to direct migrated traffic toward",
              "name": "migrationConfigs",
            },
            {
              "name": "uniqueRunNonce",
            },
            {
              "name": "imageCaptureProxyLocation",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "captureProxyImage",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
            {
              "name": "imageCaptureProxyPullPolicy",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "captureProxyPullPolicy",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
            {
              "name": "imageTrafficReplayerLocation",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "trafficReplayerImage",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
            {
              "name": "imageTrafficReplayerPullPolicy",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "trafficReplayerPullPolicy",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
            {
              "name": "imageReindexFromSnapshotLocation",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "reindexFromSnapshotImage",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
            {
              "name": "imageReindexFromSnapshotPullPolicy",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "reindexFromSnapshotPullPolicy",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
            {
              "name": "imageMigrationConsoleLocation",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "migrationConsoleImage",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
            {
              "name": "imageMigrationConsolePullPolicy",
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "migrationConsolePullPolicy",
                  "name": "{{workflow.parameters.imageConfigMapName}}",
                  "optional": undefined,
                },
              },
            },
          ],
        },
        "name": "main",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "uniqueRunNonce",
                    "value": "{{inputs.parameters.uniqueRunNonce}}",
                  },
                  {
                    "name": "imageCaptureProxyLocation",
                    "value": "{{inputs.parameters.imageCaptureProxyLocation}}",
                  },
                  {
                    "name": "imageCaptureProxyPullPolicy",
                    "value": "{{inputs.parameters.imageCaptureProxyPullPolicy}}",
                  },
                  {
                    "name": "imageTrafficReplayerLocation",
                    "value": "{{inputs.parameters.imageTrafficReplayerLocation}}",
                  },
                  {
                    "name": "imageTrafficReplayerPullPolicy",
                    "value": "{{inputs.parameters.imageTrafficReplayerPullPolicy}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotLocation",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotLocation}}",
                  },
                  {
                    "name": "imageReindexFromSnapshotPullPolicy",
                    "value": "{{inputs.parameters.imageReindexFromSnapshotPullPolicy}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "sourceConfig",
                    "value": "{{=jsonpath(toJSON(item), '$.sourceConfig')}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{=jsonpath(toJSON(item), '$.targetConfig')}}",
                  },
                  {
                    "name": "snapshotExtractAndLoadConfigArray",
                    "value": "{{=sprig.dig('snapshotExtractAndLoadConfigArray', '', item)}}",
                  },
                  {
                    "name": "replayerConfig",
                    "value": "{{=sprig.dig('replayerConfig', '', item)}}",
                  },
                ],
              },
              "name": "migration",
              "template": "migration",
              "withParam": "{{inputs.parameters.migrationConfigs}}",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "prefix",
                    "value": "{{inputs.parameters.uniqueRunNonce}}",
                  },
                ],
              },
              "name": "cleanup",
              "templateRef": {
                "name": "target-latch-helpers",
                "template": "cleanup",
              },
            },
          ],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings full-migration-with-workflow-cli 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "full-migration-with-workflow-cli",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": "main",
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "container": {
          "args": [
            "#!/bin/bash
#
# ============================================================================
# WARNING: TEST HELPER SCRIPT - SHOULD BE MOVED TO SEPARATE PACKAGE
# ============================================================================
# This script is part of the test workflow infrastructure and creates a
# logical dependency cycle:
# - migration-workflow-templates package provides workflow templates
# - workflow CLI (in migration console) depends on migration-workflow-templates
# - This test script depends on workflow CLI
#
# TODO: Move test workflows and helpers to a separate package (e.g.,
# migration-workflow-templates-test) to break this dependency cycle.
# ============================================================================

set -e -x

# Activate the Python virtual environment to get access to workflow CLI
. /etc/profile.d/venv.sh
source /.venv/bin/activate

echo "Building and submitting migration workflow..."

# Decode base64 migration config from environment variable and write to file
echo "$MIGRATION_CONFIG_BASE64" | base64 -d > /tmp/migration_config.json

echo "Migration config contents:"
cat /tmp/migration_config.json

echo "Loading configuration from JSON..."
cat /tmp/migration_config.json | workflow configure edit --stdin

# Submit workflow
echo "Submitting workflow..."
WORKFLOW_OUTPUT=$(workflow submit 2>&1)
EXIT_CODE=$?
echo "Workflow submit output: $WORKFLOW_OUTPUT"
[ $EXIT_CODE -eq 0 ] || exit $EXIT_CODE
",
          ],
          "command": [
            "/bin/bash",
            "-c",
          ],
          "env": [
            {
              "name": "MIGRATION_CONFIG_BASE64",
              "value": "{{inputs.parameters.migrationConfigBase64}}",
            },
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "migrationConfigBase64",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "configureandsubmitworkflow",
        "outputs": {
          "parameters": [],
        },
      },
      {
        "container": {
          "args": [
            "#!/bin/bash
#
# ============================================================================
# WARNING: TEST HELPER SCRIPT - SHOULD BE MOVED TO SEPARATE PACKAGE
# ============================================================================
# This script is part of the test workflow infrastructure and creates a
# logical dependency cycle:
# - migration-workflow-templates package provides workflow templates
# - workflow CLI (in migration console) depends on migration-workflow-templates
# - This test script depends on workflow CLI
#
# TODO: Move test workflows and helpers to a separate package (e.g.,
# migration-workflow-templates-test) to break this dependency cycle.
# ============================================================================

set -e -x

echo "Checking workflow status"
. /etc/profile.d/venv.sh
source /.venv/bin/activate

STATUS_OUTPUT=$(workflow status --workflow-name migration-workflow 2>&1)
STATUS_EXIT_CODE=$?
echo "Status output:"
echo "$STATUS_OUTPUT"

# If the command failed (e.g., connection error), retry
if [ $STATUS_EXIT_CODE -ne 0 ]; then
    echo "Failed to get workflow status (exit code: $STATUS_EXIT_CODE), will retry..."
    exit 1
fi

# Check if workflow is running or pending - retry
if echo "$STATUS_OUTPUT" | grep -q "Phase: Running\\|Phase: Pending"; then
    echo "Workflow still running or pending, will retry..."
    exit 1
fi

# All other states are terminal (Succeeded, Failed, Suspended, Error, etc.)
echo "Workflow is in terminal state"
mkdir -p /tmp/outputs
echo "$STATUS_OUTPUT" > /tmp/outputs/monitorResult
exit 0
",
          ],
          "command": [
            "/bin/bash",
            "-c",
          ],
          "env": [],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "monitorworkflow",
        "outputs": {
          "parameters": [
            {
              "description": "Workflow status output from monitor script",
              "name": "monitorResult",
              "valueFrom": {
                "path": "/tmp/outputs/monitorResult",
              },
            },
          ],
        },
        "retryStrategy": {
          "backoff": {
            "cap": "60",
            "duration": "5",
            "factor": "2",
          },
          "limit": "33",
          "retryPolicy": "Always",
        },
      },
      {
        "container": {
          "args": [
            "
set -e
echo "Evaluating workflow result..."
echo "Monitor output: $MONITOR_RESULT"

# Check if the output contains "Phase: Succeeded"
if echo "$MONITOR_RESULT" | grep -q "Phase: Succeeded"; then
    echo "Migration workflow completed successfully"
    exit 0
else
    echo "Migration workflow did not succeed"
    exit 1
fi
            ",
          ],
          "command": [
            "/bin/bash",
            "-c",
          ],
          "env": [
            {
              "name": "MONITOR_RESULT",
              "value": "{{inputs.parameters.monitorResult}}",
            },
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "monitorResult",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "evaluateworkflowresult",
        "outputs": {
          "parameters": [],
        },
      },
      {
        "inputs": {
          "parameters": [],
        },
        "name": "deletemigrationworkflow",
        "outputs": {
          "parameters": [],
        },
        "resource": {
          "action": "delete",
          "flags": [
            "--ignore-not-found",
          ],
          "manifest": "apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: migration-workflow
",
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "migrationConfigBase64",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "main",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "migrationConfigBase64",
                    "value": "{{inputs.parameters.migrationConfigBase64}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                ],
              },
              "name": "configureAndSubmitWorkflow",
              "template": "configureandsubmitworkflow",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                ],
              },
              "name": "monitorWorkflow",
              "template": "monitorworkflow",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "monitorResult",
                    "value": "{{steps.monitorWorkflow.outputs.parameters.monitorResult}}",
                  },
                ],
              },
              "name": "evaluateWorkflowResult",
              "template": "evaluateworkflowresult",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [],
              },
              "name": "deleteMigrationWorkflow",
              "template": "deletemigrationworkflow",
            },
          ],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings metadata-migration 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "metadata-migration",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "container": {
          "args": [
            "{{inputs.parameters.commandMode}}",
            "---INLINE-JSON",
            "{{=toJSON(sprig.merge(sprig.merge(sprig.merge(sprig.merge((('authConfig' in fromJSON(inputs.parameters.targetConfig)) ? ((('sigv4' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict("targetAwsServiceSigningName", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['service'], "targetAwsRegion", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['region'])) : ((('mtls' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict("targetCaCert", fromJSON(inputs.parameters.targetConfig)['authConfig']['mtls']['caCert'])) : ({}))))) : ({})), (('endpoint' in fromJSON(inputs.parameters.targetConfig)) ? (sprig.dict("targetHost", fromJSON(inputs.parameters.targetConfig)['endpoint'])) : ({}))), sprig.dict("targetInsecure", sprig.dig('allowInsecure', false, fromJSON(inputs.parameters.targetConfig)))), sprig.omit(fromJSON(inputs.parameters.metadataMigrationConfig), 'loggingConfigurationOverrideConfigMap')), sprig.merge(sprig.dict("snapshotName", fromJSON(inputs.parameters.snapshotConfig)['snapshotName'], "sourceVersion", fromJSON(inputs.parameters.sourceConfig)['version']), sprig.merge(sprig.merge(((0 == len(sprig.dig('endpoint', '', sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')))) ? (sprig.dict()) : (sprig.dict("s3Endpoint", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['endpoint']))), ((0 == len(sprig.dig('s3RoleArn', '', sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')))) ? (sprig.dict()) : (sprig.dict("s3RoleArn", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['s3RoleArn'])))), sprig.dict("s3RepoUri", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['s3RepoPathUri'], "s3Region", sprig.omit(fromJSON(inputs.parameters.snapshotConfig)['repoConfig'], 's3RoleArn')['awsRegion'], "s3LocalDir", '/tmp')))))}}",
          ],
          "command": [
            "/root/metadataMigration/bin/MetadataMigration",
          ],
          "env": [
            {
              "name": "AWS_SHARED_CREDENTIALS_FILE",
              "value": "{{=((sprig.dig('repoConfig', 'useLocalStack', false, fromJSON(inputs.parameters.snapshotConfig))) ? ('/config/credentials/configuration') : (''))}}",
            },
            {
              "name": "TARGET_USERNAME",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "username",
                  "name": "{{=((0 == len(sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig)))) ? ('empty') : (sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig))))}}",
                  "optional": true,
                },
              },
            },
            {
              "name": "TARGET_PASSWORD",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "password",
                  "name": "{{=((0 == len(sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig)))) ? ('empty') : (sprig.dig('authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.targetConfig))))}}",
                  "optional": true,
                },
              },
            },
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
          "volumeMounts": [
            {
              "mountPath": "/config/credentials",
              "name": "test-creds",
              "readOnly": true,
            },
          ],
        },
        "inputs": {
          "parameters": [
            {
              "name": "commandMode",
            },
            {
              "name": "sourceConfig",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "snapshotConfig",
            },
            {
              "name": "metadataMigrationConfig",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
            {
              "name": "sourceK8sLabel",
            },
            {
              "name": "targetK8sLabel",
            },
            {
              "name": "snapshotK8sLabel",
            },
            {
              "name": "fromSnapshotMigrationK8sLabel",
            },
            {
              "name": "taskK8sLabel",
              "value": "{{=((inputs.parameters.commandMode == 'evaluate') ? ('metadataEvaluate') : ('metadataMigrate'))}}",
            },
          ],
        },
        "metadata": {
          "labels": {
            "migrations.opensearch.org/from-snapshot-migration": "{{inputs.parameters.fromSnapshotMigrationK8sLabel}}",
            "migrations.opensearch.org/snapshot": "{{inputs.parameters.snapshotK8sLabel}}",
            "migrations.opensearch.org/source": "{{inputs.parameters.sourceK8sLabel}}",
            "migrations.opensearch.org/target": "{{inputs.parameters.targetK8sLabel}}",
            "migrations.opensearch.org/task": "{{inputs.parameters.taskK8sLabel}}",
          },
        },
        "name": "runmetadata",
        "outputs": {
          "parameters": [],
        },
        "volumes": [
          {
            "configMap": {
              "name": "localstack-test-creds",
              "optional": true,
            },
            "name": "test-creds",
          },
        ],
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "name",
            },
          ],
        },
        "name": "approveevaluate",
        "outputs": {
          "parameters": [],
        },
        "suspend": {},
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "name",
            },
          ],
        },
        "name": "approvemigrate",
        "outputs": {
          "parameters": [],
        },
        "suspend": {},
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "metadataMigrationConfig",
            },
            {
              "description": "Snapshot storage details (region, endpoint, etc)",
              "name": "snapshotConfig",
            },
            {
              "name": "sourceConfig",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "migrationLabel",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
            {
              "name": "skipApprovalMap",
              "value": {},
              "valueFrom": {
                "configMapKeyRef": {
                  "key": "autoApprove",
                  "name": "{{workflow.parameters.approvalConfigMapName}}",
                  "optional": true,
                },
              },
            },
            {
              "name": "skipEvaluateApproval",
              "value": "{{=sprig.dig(fromJSON(inputs.parameters.sourceConfig)['label'], fromJSON(inputs.parameters.targetConfig)['label'], jsonpath(inputs.parameters.snapshotConfig, '$.label'), inputs.parameters.migrationLabel, 'evaluateMetadata', false, fromJSON(inputs.parameters.skipApprovalMap))}}",
            },
            {
              "name": "skipMigrateApproval",
              "value": "{{=sprig.dig(fromJSON(inputs.parameters.sourceConfig)['label'], fromJSON(inputs.parameters.targetConfig)['label'], jsonpath(inputs.parameters.snapshotConfig, '$.label'), inputs.parameters.migrationLabel, 'migrateMetadata', false, fromJSON(inputs.parameters.skipApprovalMap))}}",
            },
            {
              "name": "approvalNamePrefix",
              "value": "{{=jsonpath(inputs.parameters.sourceConfig, '$.label')+'.'+jsonpath(inputs.parameters.targetConfig, '$.label')+'.'+jsonpath(inputs.parameters.snapshotConfig, '$.label')+'.'+inputs.parameters.migrationLabel+'.'}}",
            },
          ],
        },
        "name": "migratemetadata",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "metadataMigrationConfig",
                    "value": "{{inputs.parameters.metadataMigrationConfig}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "commandMode",
                    "value": "evaluate",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.sourceConfig, '$.label')}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.targetConfig, '$.label')}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}",
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.migrationLabel}}",
                  },
                ],
              },
              "name": "evaluateMetadata",
              "template": "runmetadata",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "name",
                    "value": "{{=inputs.parameters.approvalNamePrefix+'evaluateMetadata'}}",
                  },
                ],
              },
              "name": "approveEvaluate",
              "template": "approveevaluate",
              "when": "!({{inputs.parameters.skipEvaluateApproval}})",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "metadataMigrationConfig",
                    "value": "{{inputs.parameters.metadataMigrationConfig}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "commandMode",
                    "value": "migrate",
                  },
                  {
                    "name": "sourceK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.sourceConfig, '$.label')}}",
                  },
                  {
                    "name": "targetK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.targetConfig, '$.label')}}",
                  },
                  {
                    "name": "snapshotK8sLabel",
                    "value": "{{=jsonpath(inputs.parameters.snapshotConfig, '$.label')}}",
                  },
                  {
                    "name": "fromSnapshotMigrationK8sLabel",
                    "value": "{{inputs.parameters.migrationLabel}}",
                  },
                ],
              },
              "name": "migrateMetadata",
              "template": "runmetadata",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "name",
                    "value": "{{=inputs.parameters.approvalNamePrefix+'migrateMetadata'}}",
                  },
                ],
              },
              "name": "approveMigrate",
              "template": "approvemigrate",
              "when": "{{=!(fromJSON(inputs.parameters.skipMigrateApproval))}}",
            },
          ],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings migration-console 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "migration-console",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [
            {
              "description": "The metadata about the deployment performing the RFS backfill",
              "name": "backfillSession",
              "value": "",
            },
            {
              "description": "Snapshot configuration information (JSON)",
              "name": "kafkaInfo",
              "value": "",
            },
            {
              "description": "Source cluster configuration (JSON)",
              "name": "sourceConfig",
              "value": "",
            },
            {
              "description": "Snapshot configuration information (JSON)",
              "name": "snapshotConfig",
              "value": "",
            },
            {
              "description": "Target cluster configuration (JSON)",
              "name": "targetConfig",
              "value": "",
            },
          ],
        },
        "name": "getconsoleconfig",
        "outputs": {
          "parameters": [
            {
              "name": "configContents",
              "valueFrom": {
                "expression": "toJSON(sprig.merge(sprig.merge(sprig.merge(((0 == len(inputs.parameters.kafkaInfo)) ? ({}) : (sprig.dict("kafka", fromJSON(inputs.parameters.kafkaInfo)))), ((0 == len(inputs.parameters.sourceConfig)) ? ({}) : (sprig.dict("source_cluster", fromJSON(inputs.parameters.sourceConfig))))), sprig.merge(((0 == len(inputs.parameters.targetConfig)) ? ({}) : (sprig.dict("target_cluster", fromJSON(inputs.parameters.targetConfig)))), ((0 == len(inputs.parameters.snapshotConfig)) ? ({}) : (sprig.dict("snapshot", fromJSON(inputs.parameters.snapshotConfig)))))), ((0 == len(inputs.parameters.backfillSession)) ? ({}) : (sprig.dict("backfill", sprig.dict("reindex_from_snapshot", sprig.dict("k8s", sprig.dict("namespace", "{{workflow.namespace}}", "deployment_name", fromJSON(inputs.parameters.backfillSession)['deploymentName']), "backfill_session_name", fromJSON(inputs.parameters.backfillSession)['sessionName'])))))))",
              },
            },
          ],
        },
        "steps": [
          [],
        ],
      },
      {
        "container": {
          "args": [
            "
set -e -x

# Save pod name to output path
echo $HOSTNAME > /tmp/podname

echo File contents...
 
base64 -d > /config/migration_services.yaml_ << EOF
{{=toBase64(inputs.parameters.configContents)}}
EOF

cat /config/migration_services.yaml_ |
jq -f workflowConfigToServicesConfig.jq > /config/migration_services.yaml

. /etc/profile.d/venv.sh
source /.venv/bin/activate

echo file dump
echo ---
export MIGRATION_USE_SERVICES_YAML_CONFIG=true
cat /config/migration_services.yaml
echo ---

{{inputs.parameters.command}}
",
          ],
          "command": [
            "/bin/sh",
            "-c",
          ],
          "env": [
            {
              "name": "SOURCE_USERNAME",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "username",
                  "name": "{{=((0 == len(sprig.dig('source_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents)))) ? ('empty') : (sprig.dig('source_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents))))}}",
                  "optional": true,
                },
              },
            },
            {
              "name": "SOURCE_PASSWORD",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "password",
                  "name": "{{=((0 == len(sprig.dig('source_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents)))) ? ('empty') : (sprig.dig('source_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents))))}}",
                  "optional": true,
                },
              },
            },
            {
              "name": "TARGET_USERNAME",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "username",
                  "name": "{{=((0 == len(sprig.dig('target_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents)))) ? ('empty') : (sprig.dig('target_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents))))}}",
                  "optional": true,
                },
              },
            },
            {
              "name": "TARGET_PASSWORD",
              "valueFrom": {
                "secretKeyRef": {
                  "key": "password",
                  "name": "{{=((0 == len(sprig.dig('target_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents)))) ? ('empty') : (sprig.dig('target_cluster', 'authConfig', 'basic', 'secretName', '', fromJSON(inputs.parameters.configContents))))}}",
                  "optional": true,
                },
              },
            },
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "command",
            },
            {
              "name": "configContents",
            },
            {
              "name": "sourceK8sLabel",
              "value": "",
            },
            {
              "name": "targetK8sLabel",
              "value": "",
            },
            {
              "name": "snapshotK8sLabel",
              "value": "",
            },
            {
              "name": "fromSnapshotMigrationK8sLabel",
              "value": "",
            },
            {
              "name": "taskK8sLabel",
              "value": "",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "metadata": {
          "labels": {
            "migrations.opensearch.org/from-snapshot-migration": "{{inputs.parameters.fromSnapshotMigrationK8sLabel}}",
            "migrations.opensearch.org/snapshot": "{{inputs.parameters.snapshotK8sLabel}}",
            "migrations.opensearch.org/source": "{{inputs.parameters.sourceK8sLabel}}",
            "migrations.opensearch.org/target": "{{inputs.parameters.targetK8sLabel}}",
            "migrations.opensearch.org/task": "{{inputs.parameters.taskK8sLabel}}",
          },
        },
        "name": "runmigrationcommandforstatus",
        "outputs": {
          "parameters": [
            {
              "name": "statusOutput",
              "valueFrom": {
                "path": "/tmp/status-output.txt",
              },
            },
            {
              "name": "overriddenPhase",
              "valueFrom": {
                "path": "/tmp/phase-output.txt",
              },
            },
          ],
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "command",
            },
            {
              "description": "The metadata about the deployment performing the RFS backfill",
              "name": "backfillSession",
              "value": "",
            },
            {
              "description": "Snapshot configuration information (JSON)",
              "name": "kafkaInfo",
              "value": "",
            },
            {
              "description": "Source cluster configuration (JSON)",
              "name": "sourceConfig",
              "value": "",
            },
            {
              "description": "Snapshot configuration information (JSON)",
              "name": "snapshotConfig",
              "value": "",
            },
            {
              "description": "Target cluster configuration (JSON)",
              "name": "targetConfig",
              "value": "",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "runconsole",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "backfillSession",
                    "value": "{{inputs.parameters.backfillSession}}",
                  },
                  {
                    "name": "kafkaInfo",
                    "value": "{{inputs.parameters.kafkaInfo}}",
                  },
                  {
                    "name": "sourceConfig",
                    "value": "{{inputs.parameters.sourceConfig}}",
                  },
                  {
                    "name": "snapshotConfig",
                    "value": "{{inputs.parameters.snapshotConfig}}",
                  },
                  {
                    "name": "targetConfig",
                    "value": "{{inputs.parameters.targetConfig}}",
                  },
                ],
              },
              "name": "getConsoleConfig",
              "template": "getconsoleconfig",
            },
          ],
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "command",
                    "value": "{{inputs.parameters.command}}",
                  },
                  {
                    "name": "imageMigrationConsoleLocation",
                    "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
                  },
                  {
                    "name": "imageMigrationConsolePullPolicy",
                    "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
                  },
                  {
                    "name": "configContents",
                    "value": "{{steps.getConsoleConfig.outputs.parameters.configContents}}",
                  },
                ],
              },
              "name": "runConsoleWithConfig",
              "template": "runmigrationcommandforstatus",
            },
          ],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings replayer 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "replayer",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [
            {
              "name": "sessionName",
            },
            {
              "name": "jsonConfig",
            },
            {
              "name": "podReplicas",
            },
            {
              "name": "loggingConfigurationOverrideConfigMap",
            },
            {
              "name": "imageTrafficReplayerLocation",
            },
            {
              "name": "imageTrafficReplayerPullPolicy",
            },
            {
              "name": "resources",
            },
          ],
        },
        "name": "createdeployment",
        "outputs": {
          "parameters": [],
        },
        "resource": {
          "action": "create",
          "manifest": "apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{=inputs.parameters.sessionName+'-replayer'}}"
  labels:
    app: replayer
    workflows.argoproj.io/workflow: "{{workflow.name}}"
spec:
  replicas: "{{inputs.parameters.podReplicas}}"
  selector:
    matchLabels:
      app: replayer
  template:
    metadata:
      labels:
        app: replayer
        workflows.argoproj.io/workflow: "{{workflow.name}}"
    spec:
      serviceAccountName: argo-workflow-executor
      containers:
        - name: replayer
          image: "{{inputs.parameters.imageTrafficReplayerLocation}}"
          imagePullPolicy: "{{inputs.parameters.imageTrafficReplayerPullPolicy}}"
          command:
            - /runJavaWithClasspath.sh
          args:
            - org.opensearch.migrations.replay.TrafficReplayer
            - ---INLINE-JSON
            - "{{=toBase64(inputs.parameters.jsonConfig)}}"
          resources: {{=fromJSON(inputs.parameters.resources)}}
          env:
            - name: JAVA_OPTS
              value: "{{=' ' + ' ' + (('' == inputs.parameters.loggingConfigurationOverrideConfigMap) ? ('-Dlog4j2.configurationFile=/config/logConfiguration') : (''))}}"
          volumeMounts:
            - name: log4j-configuration
              mountPath: /config/logConfiguration
              readOnly: true
      volumes:
        - name: log4j-configuration
          configMap:
            name: "{{=((0 == len(inputs.parameters.loggingConfigurationOverrideConfigMap)) ? ('default-log4j-config') : (inputs.parameters.loggingConfigurationOverrideConfigMap))}}"
            optional: {{=!('' == inputs.parameters.loggingConfigurationOverrideConfigMap)}}
",
          "setOwnerReference": true,
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "kafkaTrafficBrokers",
            },
            {
              "name": "kafkaTrafficTopic",
            },
            {
              "name": "kafkaGroupId",
            },
            {
              "name": "targetConfig",
            },
            {
              "name": "replayerConfig",
            },
            {
              "name": "podReplicas",
              "value": "1",
            },
            {
              "name": "imageTrafficReplayerLocation",
            },
            {
              "name": "imageTrafficReplayerPullPolicy",
            },
          ],
        },
        "name": "createdeploymentfromconfig",
        "outputs": {
          "parameters": [],
        },
        "steps": [
          [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "podReplicas",
                    "value": "{{=jsonpath(toJSON(fromJSON(inputs.parameters.replayerConfig)), '$.podReplicas')}}",
                  },
                  {
                    "name": "imageTrafficReplayerLocation",
                    "value": "{{inputs.parameters.imageTrafficReplayerLocation}}",
                  },
                  {
                    "name": "imageTrafficReplayerPullPolicy",
                    "value": "{{inputs.parameters.imageTrafficReplayerPullPolicy}}",
                  },
                  {
                    "name": "targetAwsRegion",
                    "value": "{{=sprig.dig('authConfig', 'sigv4', 'region', '', fromJSON(inputs.parameters.targetConfig))}}",
                  },
                  {
                    "name": "targetAwsSigningName",
                    "value": "{{=sprig.dig('authConfig', 'sigv4', 'service', '', fromJSON(inputs.parameters.targetConfig))}}",
                  },
                  {
                    "name": "targetCACert",
                    "value": "{{=sprig.dig('authConfig', 'mtls', 'caCert', '', fromJSON(inputs.parameters.targetConfig))}}",
                  },
                  {
                    "name": "targetClientSecretName",
                    "value": "{{=sprig.dig('authConfig', 'mtls', 'clientSecretName', '', fromJSON(inputs.parameters.targetConfig))}}",
                  },
                  {
                    "name": "targetInsecure",
                    "value": "{{=sprig.dig('allowInsecure', false, fromJSON(inputs.parameters.targetConfig))}}",
                  },
                  {
                    "name": "speedupFactor",
                    "value": "{{=jsonpath(toJSON(fromJSON(inputs.parameters.replayerConfig)), '$.speedupFactor')}}",
                  },
                  {
                    "name": "authHeaderOverride",
                    "value": "{{=jsonpath(toJSON(fromJSON(inputs.parameters.replayerConfig)), '$.authHeaderOverride')}}",
                  },
                  {
                    "name": "loggingConfigurationOverrideConfigMap",
                    "value": "{{=jsonpath(toJSON(fromJSON(inputs.parameters.replayerConfig)), '$.loggingConfigurationOverrideConfigMap')}}",
                  },
                  {
                    "name": "resources",
                    "value": "{{=toJSON(fromJSON(inputs.parameters.replayerConfig)['resources'])}}",
                  },
                  {
                    "name": "sessionName",
                    "value": "",
                  },
                  {
                    "name": "jsonConfig",
                    "value": "{{=toJSON(sprig.merge(sprig.merge(sprig.merge(sprig.merge((('authConfig' in fromJSON(inputs.parameters.targetConfig)) ? ((('sigv4' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict("targetAwsServiceSigningName", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['service'], "targetAwsRegion", fromJSON(inputs.parameters.targetConfig)['authConfig']['sigv4']['region'])) : ((('mtls' in fromJSON(inputs.parameters.targetConfig)['authConfig']) ? (sprig.dict("targetCaCert", fromJSON(inputs.parameters.targetConfig)['authConfig']['mtls']['caCert'])) : ({}))))) : ({})), (('endpoint' in fromJSON(inputs.parameters.targetConfig)) ? (sprig.dict("targetHost", fromJSON(inputs.parameters.targetConfig)['endpoint'])) : ({}))), sprig.dict("targetInsecure", sprig.dig('allowInsecure', false, fromJSON(inputs.parameters.targetConfig)))), sprig.omit(fromJSON(inputs.parameters.replayerConfig), 'loggingConfigurationOverrideConfigMap', 'podReplicas', 'resources')), sprig.merge(sprig.dict(), sprig.dict())))}}",
                  },
                ],
              },
              "name": "deployReplayer",
              "template": "createdeployment",
            },
          ],
        ],
      },
    ],
  },
}
`;

exports[`test workflow template renderings setup-kafka 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "setup-kafka",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "inputs": {
          "parameters": [
            {
              "name": "kafkaName",
            },
          ],
        },
        "name": "deploykafkaclusterzookeeper",
        "outputs": {
          "parameters": [
            {
              "name": "brokers",
              "valueFrom": {
                "path": "{.status.listeners[?(@.name=='plain')].bootstrapServers}",
              },
            },
          ],
        },
        "resource": {
          "action": "create",
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: "{{inputs.parameters.kafkaName}}"
spec:
  kafka:
    version: 3.9.0
    replicas: 1
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
    config:
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1
      inter.broker.protocol.version: "3.9"
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
    userOperator: {}
",
          "setOwnerReference": true,
          "successCondition": "status.listeners",
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "kafkaName",
            },
          ],
        },
        "name": "deploykafkanodepool",
        "outputs": {
          "parameters": [],
        },
        "resource": {
          "action": "apply",
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: dual-role
  labels:
    strimzi.io/cluster: "{{inputs.parameters.kafkaName}}"
spec:
  replicas: 1
  roles:
    - controller
    - broker
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 5Gi
        deleteClaim: false
        kraftMetadata: shared
",
          "setOwnerReference": true,
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "kafkaName",
            },
          ],
        },
        "name": "deploykafkaclusterkraft",
        "outputs": {
          "parameters": [
            {
              "name": "brokers",
              "valueFrom": {
                "path": "{.status.listeners[?(@.name=='plain')].bootstrapServers}",
              },
            },
          ],
        },
        "resource": {
          "action": "apply",
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: "{{inputs.parameters.kafkaName}}"
  annotations:
    strimzi.io/node-pools: enabled
    strimzi.io/kraft: enabled
spec:
  kafka:
    version: 3.9.0
    metadataVersion: 3.9-IV0
    readinessProbe:
      initialDelaySeconds: 1
      periodSeconds: 2
      timeoutSeconds: 2
      failureThreshold: 1
    livenessProbe:
      initialDelaySeconds: 1
      periodSeconds: 2
      timeoutSeconds: 2
      failureThreshold: 2
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
    config:
      auto.create.topics.enable: false
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1
  entityOperator:
    topicOperator: {}
    userOperator: {}
",
          "setOwnerReference": true,
          "successCondition": "status.listeners",
        },
      },
      {
        "dag": {
          "tasks": [
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "kafkaName",
                    "value": "{{inputs.parameters.kafkaName}}",
                  },
                ],
              },
              "name": "deployPool",
              "template": "deploykafkanodepool",
              "when": "{{inputs.parameters.useKraft}}",
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "kafkaName",
                    "value": "{{inputs.parameters.kafkaName}}",
                  },
                ],
              },
              "name": "deployKafkaClusterKraft",
              "template": "deploykafkaclusterkraft",
              "when": "{{inputs.parameters.useKraft}}",
            },
            {
              "arguments": {
                "parameters": [
                  {
                    "name": "kafkaName",
                    "value": "{{inputs.parameters.kafkaName}}",
                  },
                ],
              },
              "name": "deployKafkaClusterZookeeper",
              "template": "deploykafkaclusterzookeeper",
              "when": "!({{inputs.parameters.useKraft}})",
            },
          ],
        },
        "inputs": {
          "parameters": [
            {
              "name": "kafkaName",
            },
            {
              "name": "useKraft",
              "value": "true",
            },
          ],
        },
        "name": "clusterdeploy",
        "outputs": {
          "parameters": [
            {
              "name": "kafkaName",
              "valueFrom": {
                "expression": "inputs.parameters.kafkaName",
              },
            },
            {
              "name": "bootstrapServers",
              "valueFrom": {
                "expression": "(('Skipped' == tasks.deployKafkaClusterKraft.status) ? (tasks.deployKafkaClusterZookeeper.outputs.parameters.brokers) : (tasks.deployKafkaClusterKraft.outputs.parameters.brokers))",
              },
            },
          ],
        },
      },
      {
        "inputs": {
          "parameters": [
            {
              "name": "kafkaName",
            },
            {
              "name": "topicName",
            },
            {
              "name": "topicPartitions",
            },
            {
              "name": "topicReplicas",
            },
          ],
        },
        "name": "createkafkatopic",
        "outputs": {
          "parameters": [
            {
              "name": "topicName",
              "valueFrom": {
                "path": "{.status.topicName}",
              },
            },
          ],
        },
        "resource": {
          "action": "apply",
          "manifest": "apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: "{{inputs.parameters.topicName}}"
  labels:
    strimzi.io/cluster: "{{inputs.parameters.kafkaName}}"
spec:
  partitions: "{{inputs.parameters.topicPartitions}}"
  replicas: "{{inputs.parameters.topicReplicas}}"
  config:
    retention.ms: 604800000
    segment.bytes: 1073741824
",
          "setOwnerReference": true,
          "successCondition": "status.topicName",
        },
      },
    ],
  },
}
`;

exports[`test workflow template renderings target-latch-helpers 1`] = `
{
  "apiVersion": "argoproj.io/v1alpha1",
  "kind": "WorkflowTemplate",
  "metadata": {
    "name": "target-latch-helpers",
  },
  "spec": {
    "arguments": {
      "parameters": [
        {
          "name": "etcdEndpoints",
          "value": "http://etcd.ma.svc.cluster.local:2379",
        },
        {
          "name": "etcdUser",
          "value": "root",
        },
        {
          "name": "etcdPassword",
          "value": "password",
        },
        {
          "name": "s3SnapshotConfigMap",
          "value": "s3-snapshot-config",
        },
        {
          "name": "imageConfigMapName",
          "value": "migration-image-config",
        },
        {
          "name": "approvalConfigMapName",
          "value": "approval-config",
        },
      ],
    },
    "entrypoint": undefined,
    "parallelism": 100,
    "serviceAccountName": "argo-workflow-executor",
    "templates": [
      {
        "container": {
          "args": [
            "#!/bin/bash
set -e

# Import Library
#!/bin/bash

# Optional Parameters - 5 minute total retry window
ETCD_RETRIES=\${ETCD_RETRIES:-30}
ETCD_RETRY_DELAY=\${ETCD_RETRY_DELAY:-5}
ETCD_DIAL_TIMEOUT=\${ETCD_DIAL_TIMEOUT:-"10s"}
ETCD_CMD_TIMEOUT=\${ETCD_CMD_TIMEOUT:-"10s"}

# Required Parameters
if [ -z "$ETCD_ENDPOINTS" ]; then
  echo "Error: ETCD_ENDPOINTS is not set." >&2
  exit 1
fi

# Export the base command with timeouts so it fails fast rather than hanging
export ETCDCTL_API=3
export ETCD_CMD="etcdctl --endpoints=$ETCD_ENDPOINTS --user $ETCD_USER:$ETCD_PASSWORD --dial-timeout=$ETCD_DIAL_TIMEOUT --command-timeout=$ETCD_CMD_TIMEOUT"

# Run an arbitrary command that doesn't need to return/handle stdout from etcdctl (like WRITE/DELETE)
# Usage: etcd_safe_run put key value
etcd_safe_run() {
  local attempt=1
  local cmd="$*"

  while [ $attempt -le $ETCD_RETRIES ]; do
    # We temporarily disable 'set -e' to catch the failure
    set +e
    $ETCD_CMD "$@" > /dev/null
    local status=$?
    set -e

    if [ $status -eq 0 ]; then
      return 0
    fi

    echo "[etcd_lib] Command failed (Attempt $attempt/$ETCD_RETRIES): $cmd" >&2
    sleep $ETCD_RETRY_DELAY
    attempt=$((attempt + 1))
  done

  echo "[etcd_lib] Critical: Max retries reached for operation." >&2
  return 1
}

# Wrapper for getting values safely
# This is separate from etcd_safe_run since the output for get needs to be captured
# Usage: MY_VAR=$(etcd_safe_get "my/key")
etcd_safe_get() {
  local key="$1"
  local attempt=1

  while [ $attempt -le $ETCD_RETRIES ]; do
    set +e
    # Capture output and status separately, silence stderr
    local output
    output=$($ETCD_CMD get "$key" --print-value-only 2>/dev/null)
    local status=$?
    set -e

    if [ $status -eq 0 ]; then
      echo "$output"
      return 0
    fi

    # Log to stderr so we don't pollute the captured variable
    echo "[etcd_lib] Get failed (Attempt $attempt/$ETCD_RETRIES): $key" >&2
    sleep $ETCD_RETRY_DELAY
    attempt=$((attempt + 1))
  done

  return 1
}

# Wrapper for getting just keys safely
# Usage: MY_KEYS=$(etcd_safe_get_keys "my/prefix/")
# Note: Automatically adds --prefix and --keys-only
etcd_safe_get_keys() {
  local prefix="$1"
  local attempt=1

  while [ $attempt -le $ETCD_RETRIES ]; do
    set +e
    local output
    output=$($ETCD_CMD get "$prefix" --prefix --keys-only 2>/dev/null)
    local status=$?
    set -e

    if [ $status -eq 0 ]; then
      echo "$output"
      return 0
    fi

    echo "[etcd_lib] Key list fetch failed (Attempt $attempt/$ETCD_RETRIES): $prefix" >&2
    sleep $ETCD_RETRY_DELAY
    attempt=$((attempt + 1))
  done

  return 1
}


# PREFIX, PROCESSOR_ID, and TARGET_NAME env vars are set by the workflow template

normalize_endpoint() {
  echo "$1" | base64
}

NORMALIZED_TARGET=$(normalize_endpoint "$TARGET_NAME")
LATCH_KEY_NAME=/$PREFIX/workflow/targets/$NORMALIZED_TARGET/latch
FRIENDLY_NAME="\${NORMALIZED_TARGET}-\${PROCESSOR_ID}"

# Record processor completion
etcd_safe_run put "/$PREFIX/workflow/targets/$NORMALIZED_TARGET/finishedSubFlows/$FRIENDLY_NAME" "completed"

execute_transaction() {
  local current_value="$1"
  local next_value="$2"

  echo "Attempting Transaction (LATCH_KEY_NAME={$LATCH_KEY_NAME}): $current_value -> $next_value"

  # We use raw $ETCD_CMD here because heredocs don't play nice with wrapper functions
  set +e
  $ETCD_CMD txn --write-out=json << EOF | jq -e '.succeeded == true' > /dev/null
val("$LATCH_KEY_NAME") = "$current_value"

put $LATCH_KEY_NAME "$next_value"


EOF
  local status=$?
  set -e

  return $status
}

# Transaction retry loop
while true; do
  # retry for transient service errors is already built into safe get.
  # Our loop deals with the content of the key OR (later) a transient error while running the transaction
  CURRENT_COUNT=$(etcd_safe_get "$LATCH_KEY_NAME")

  # Handle case where key doesn't exist yet (empty string)
  if [ -z "$CURRENT_COUNT" ]; then
    CURRENT_COUNT=0 # Or handle error depending on your logic
  fi

  NEW_COUNT=$((CURRENT_COUNT - 1))

  if execute_transaction "$CURRENT_COUNT" "$NEW_COUNT"; then
    echo "Transaction succeeded"
    break
  else
    # This catches both:
    # A. Logical failure (value changed by someone else)
    # B. Network failure (etcd command failed)
    echo "Transaction failed (Network or compare-and-swap mismatch), retrying..."
    sleep 1
  fi
done

# Default: don't finalize yet
SHOULD_FINALIZE="false"

# Check if latch has reached zero
if [ "$NEW_COUNT" -eq 0 ]; then
  echo "All processors for target $TARGET_NAME have completed" >&2
  SHOULD_FINALIZE="true"
else
  echo "Target $TARGET_NAME still has $NEW_COUNT processors pending" >&2
fi

# Output just the boolean value to stdout for the result
echo $SHOULD_FINALIZE > /tmp/should-finalize
echo $SHOULD_FINALIZE",
          ],
          "command": [
            "sh",
            "-c",
          ],
          "env": [
            {
              "name": "PREFIX",
              "value": "{{inputs.parameters.prefix}}",
            },
            {
              "name": "ETCD_ENDPOINTS",
              "value": "{{inputs.parameters.etcdEndpoints}}",
            },
            {
              "name": "ETCD_PASSWORD",
              "value": "{{inputs.parameters.etcdPassword}}",
            },
            {
              "name": "ETCD_USER",
              "value": "{{inputs.parameters.etcdUser}}",
            },
            {
              "name": "IMAGE_MIGRATION_CONSOLE_LOCATION",
              "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
            },
            {
              "name": "IMAGE_MIGRATION_CONSOLE_PULL_POLICY",
              "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
            },
            {
              "name": "TARGET_NAME",
              "value": "{{inputs.parameters.targetName}}",
            },
            {
              "name": "PROCESSOR_ID",
              "value": "{{inputs.parameters.processorId}}",
            },
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "prefix",
            },
            {
              "name": "etcdEndpoints",
              "value": "{{workflow.parameters.etcdEndpoints}}",
            },
            {
              "name": "etcdPassword",
              "value": "{{workflow.parameters.etcdPassword}}",
            },
            {
              "name": "etcdUser",
              "value": "{{workflow.parameters.etcdUser}}",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
            {
              "name": "targetName",
            },
            {
              "name": "processorId",
            },
          ],
        },
        "name": "decrementlatch",
        "outputs": {
          "parameters": [
            {
              "name": "shouldFinalize",
              "valueFrom": {
                "path": "/tmp/should-finalize",
              },
            },
          ],
        },
      },
      {
        "container": {
          "args": [
            "#!/bin/bash
set -e

# Import Library
#!/bin/bash

# Optional Parameters - 5 minute total retry window
ETCD_RETRIES=\${ETCD_RETRIES:-30}
ETCD_RETRY_DELAY=\${ETCD_RETRY_DELAY:-5}
ETCD_DIAL_TIMEOUT=\${ETCD_DIAL_TIMEOUT:-"10s"}
ETCD_CMD_TIMEOUT=\${ETCD_CMD_TIMEOUT:-"10s"}

# Required Parameters
if [ -z "$ETCD_ENDPOINTS" ]; then
  echo "Error: ETCD_ENDPOINTS is not set." >&2
  exit 1
fi

# Export the base command with timeouts so it fails fast rather than hanging
export ETCDCTL_API=3
export ETCD_CMD="etcdctl --endpoints=$ETCD_ENDPOINTS --user $ETCD_USER:$ETCD_PASSWORD --dial-timeout=$ETCD_DIAL_TIMEOUT --command-timeout=$ETCD_CMD_TIMEOUT"

# Run an arbitrary command that doesn't need to return/handle stdout from etcdctl (like WRITE/DELETE)
# Usage: etcd_safe_run put key value
etcd_safe_run() {
  local attempt=1
  local cmd="$*"

  while [ $attempt -le $ETCD_RETRIES ]; do
    # We temporarily disable 'set -e' to catch the failure
    set +e
    $ETCD_CMD "$@" > /dev/null
    local status=$?
    set -e

    if [ $status -eq 0 ]; then
      return 0
    fi

    echo "[etcd_lib] Command failed (Attempt $attempt/$ETCD_RETRIES): $cmd" >&2
    sleep $ETCD_RETRY_DELAY
    attempt=$((attempt + 1))
  done

  echo "[etcd_lib] Critical: Max retries reached for operation." >&2
  return 1
}

# Wrapper for getting values safely
# This is separate from etcd_safe_run since the output for get needs to be captured
# Usage: MY_VAR=$(etcd_safe_get "my/key")
etcd_safe_get() {
  local key="$1"
  local attempt=1

  while [ $attempt -le $ETCD_RETRIES ]; do
    set +e
    # Capture output and status separately, silence stderr
    local output
    output=$($ETCD_CMD get "$key" --print-value-only 2>/dev/null)
    local status=$?
    set -e

    if [ $status -eq 0 ]; then
      echo "$output"
      return 0
    fi

    # Log to stderr so we don't pollute the captured variable
    echo "[etcd_lib] Get failed (Attempt $attempt/$ETCD_RETRIES): $key" >&2
    sleep $ETCD_RETRY_DELAY
    attempt=$((attempt + 1))
  done

  return 1
}

# Wrapper for getting just keys safely
# Usage: MY_KEYS=$(etcd_safe_get_keys "my/prefix/")
# Note: Automatically adds --prefix and --keys-only
etcd_safe_get_keys() {
  local prefix="$1"
  local attempt=1

  while [ $attempt -le $ETCD_RETRIES ]; do
    set +e
    local output
    output=$($ETCD_CMD get "$prefix" --prefix --keys-only 2>/dev/null)
    local status=$?
    set -e

    if [ $status -eq 0 ]; then
      echo "$output"
      return 0
    fi

    echo "[etcd_lib] Key list fetch failed (Attempt $attempt/$ETCD_RETRIES): $prefix" >&2
    sleep $ETCD_RETRY_DELAY
    attempt=$((attempt + 1))
  done

  return 1
}


# PREFIX env var is set by the workflow template
echo "===== CLEANING UP ETCD KEYS FOR PREFIX $PREFIX ====="

# Record workflow completion time
etcd_safe_run put "/$PREFIX/workflow/info/completed" "$(date +%s)"

STARTED=$(etcd_safe_get "/$PREFIX/workflow/info/started")
if [ -z "$STARTED" ]; then STARTED=$(date +%s); fi
COMPLETED=$(date +%s)
DURATION=$((COMPLETED - STARTED))

echo "Workflow completed in $DURATION seconds"

# Get workflow stats for logging purposes
echo "Workflow completion stats:"

# Keep statistics in a separate key that will persist
STATS_KEY="workflow-stats/runs/$PREFIX"

# Save summarized workflow stats to a persistent key
etcd_safe_run put "/$STATS_KEY/started" "$STARTED"
etcd_safe_run put "/$STATS_KEY/completed" "$COMPLETED"
etcd_safe_run put "/$STATS_KEY/duration" "$DURATION"

# For each target, save its finalized status and completed processors
TARGET_KEYS=$(etcd_safe_get_keys "/$PREFIX/workflow/targets/" | grep "/latch$" | sort)
for TARGET_KEY in $TARGET_KEYS; do
  TARGET_PATH=$(echo "$TARGET_KEY" | sed "s|/$PREFIX/workflow/targets/||" | sed "s|/latch$||")
  TARGET_ENDPOINT=$(etcd_safe_get "/$PREFIX/workflow/targets/$TARGET_PATH/endpoint")
  LATCH_VALUE=$(etcd_safe_get "$TARGET_KEY")

  # Save target stats
  etcd_safe_run put "/$STATS_KEY/targets/$TARGET_PATH/endpoint" "$TARGET_ENDPOINT"
  etcd_safe_run put "/$STATS_KEY/targets/$TARGET_PATH/final_latch_value" "$LATCH_VALUE"

  # Save the list of completed processor chains
  RAW_PROCESSOR_KEYS=$(etcd_safe_get_keys "/$PREFIX/workflow/targets/$TARGET_PATH/finishedSubFlows/")

  # Count Processors
  if [ -z "$RAW_PROCESSOR_KEYS" ]; then
    COMPLETED_PROCESSORS_COUNT=0
    PROCESSOR_CHAINS=""
  else
    COMPLETED_PROCESSORS_COUNT=$(echo "$RAW_PROCESSOR_KEYS" | wc -l)
    PROCESSOR_CHAINS=$(echo "$RAW_PROCESSOR_KEYS" | sort | tr '\\n' ',' | sed 's/,$//')
  fi

  etcd_safe_run put "/$STATS_KEY/targets/$TARGET_PATH/completed_processors" "$COMPLETED_PROCESSORS_COUNT"
  etcd_safe_run put "/$STATS_KEY/targets/$TARGET_PATH/processor_chains" "$PROCESSOR_CHAINS"

  echo "- Target $TARGET_ENDPOINT: Latch=$LATCH_VALUE, Completed Processors=$COMPLETED_PROCESSORS_COUNT"
done

# Delete all workflow keys for this run (but keep the stats)
echo "Deleting all workflow keys with prefix: /$PREFIX/workflow/"
etcd_safe_run del "/$PREFIX/workflow/" --prefix

echo "Cleanup complete. Workflow stats preserved under /$STATS_KEY/"",
          ],
          "command": [
            "sh",
            "-c",
          ],
          "env": [
            {
              "name": "PREFIX",
              "value": "{{inputs.parameters.prefix}}",
            },
            {
              "name": "ETCD_ENDPOINTS",
              "value": "{{inputs.parameters.etcdEndpoints}}",
            },
            {
              "name": "ETCD_PASSWORD",
              "value": "{{inputs.parameters.etcdPassword}}",
            },
            {
              "name": "ETCD_USER",
              "value": "{{inputs.parameters.etcdUser}}",
            },
            {
              "name": "IMAGE_MIGRATION_CONSOLE_LOCATION",
              "value": "{{inputs.parameters.imageMigrationConsoleLocation}}",
            },
            {
              "name": "IMAGE_MIGRATION_CONSOLE_PULL_POLICY",
              "value": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
            },
          ],
          "image": "{{inputs.parameters.imageMigrationConsoleLocation}}",
          "imagePullPolicy": "{{inputs.parameters.imageMigrationConsolePullPolicy}}",
          "resources": {
            "limits": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
            "requests": {
              "cpu": "500m",
              "memory": "2000Mi",
            },
          },
        },
        "inputs": {
          "parameters": [
            {
              "name": "prefix",
            },
            {
              "name": "etcdEndpoints",
              "value": "{{workflow.parameters.etcdEndpoints}}",
            },
            {
              "name": "etcdPassword",
              "value": "{{workflow.parameters.etcdPassword}}",
            },
            {
              "name": "etcdUser",
              "value": "{{workflow.parameters.etcdUser}}",
            },
            {
              "name": "imageMigrationConsoleLocation",
            },
            {
              "name": "imageMigrationConsolePullPolicy",
            },
          ],
        },
        "name": "cleanup",
        "outputs": {
          "parameters": [],
        },
      },
    ],
  },
}
`;
