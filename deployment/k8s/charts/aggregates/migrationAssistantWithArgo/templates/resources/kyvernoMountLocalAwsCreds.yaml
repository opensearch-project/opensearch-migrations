{{- if and .Values.conditionalPackageInstalls.kyverno .Values.kyvernoPolicies.mountLocalAwsCreds }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-kyverno-aws-creds-policy
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "9"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
data:
  policy.yaml: |
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: mount-local-aws-creds
      annotations:
        policies.kyverno.io/title: Mount Local AWS Credentials
        policies.kyverno.io/description: >-
          Mounts local AWS credentials from host path into pods for local development.
    spec:
      rules:
        - name: inject-aws-creds-volume
          match:
            any:
              - resources:
                  kinds:
                    - Pod
                  selector:
                    matchExpressions:
                      - key: serviceAccountName
                        operator: In
                        values:
                          - migration-console-access-role
          mutate:
            patchStrategicMerge:
              metadata:
                annotations:
                  kyverno.io/aws-creds-mounted: "true"
              spec:
                volumes:
                  - name: aws-creds
                    hostPath:
                      path: {{ .Values.kyvernoPolicies.mountLocalAwsCredsPath | default "~/.aws" }}
                      type: DirectoryOrCreate
        - name: inject-aws-creds-mount
          match:
            any:
              - resources:
                  kinds:
                    - Pod
                  selector:
                    matchExpressions:
                      - key: serviceAccountName
                        operator: In
                        values:
                          - migration-console-access-role
          mutate:
            foreach:
              - list: "request.object.spec.containers"
                patchStrategicMerge:
                  spec:
                    containers:
                      - name: "{{`{{ element.name }}`}}"
                        volumeMounts:
                          - name: aws-creds
                            mountPath: /root/.aws
                            readOnly: true
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-apply-kyverno-aws-creds
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    spec:
      serviceAccountName: {{ .Values.installer.serviceAccount.name }}
      restartPolicy: OnFailure
      containers:
        - name: apply-policy
          image: {{ .Values.images.installer.repository }}:{{ .Values.images.installer.tag }}
          imagePullPolicy: {{ .Values.images.installer.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for Kyverno CRD to be established..."
              kubectl wait --for=condition=Established crd/clusterpolicies.kyverno.io --timeout=300s
              echo "Waiting for Kyverno admission controller to be ready..."
              kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=admission-controller -n {{ .Values.charts.kyverno.namespace }} --timeout=120s
              kubectl apply -f /policy/policy.yaml
          volumeMounts:
            - name: policy
              mountPath: /policy
      volumes:
        - name: policy
          configMap:
            name: {{ .Release.Name }}-kyverno-aws-creds-policy
{{- end }}
