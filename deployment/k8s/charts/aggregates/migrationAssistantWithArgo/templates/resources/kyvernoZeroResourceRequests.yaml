{{- if and .Values.conditionalPackageInstalls.kyverno .Values.kyvernoPolicies.zeroResourceRequests }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-kyverno-zero-resources-policy
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "9"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
data:
  policy.yaml: |
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: zero-resource-requests
      annotations:
        policies.kyverno.io/title: Zero Resource Requests for Dev
        policies.kyverno.io/description: Zeros cpu/memory requests and limits for dev environments.
    spec:
      rules:
        - name: zero-resources
          match:
            any:
              - resources:
                  kinds:
                    - Pod
          preconditions:
            any:
              - key: "{{`{{ request.object.spec.serviceAccountName || '' }}`}}"
                operator: In
                value:
                  - migration-console-access-role
                  - argo-workflow-executor
          mutate:
            patchStrategicMerge:
              metadata:
                annotations:
                  kyverno.io/mutated-by: "zero-resource-requests"
              spec:
                containers:
                  - (name): "*"
                    resources:
                      requests:
                        cpu: "0"
                        memory: "0"
                      limits:
                        cpu: "0"
                        memory: "0"
                initContainers:
                  - (name): "*"
                    resources:
                      requests:
                        cpu: "0"
                        memory: "0"
                      limits:
                        cpu: "0"
                        memory: "0"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-apply-kyverno-zero-resources
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    spec:
      serviceAccountName: {{ .Values.installer.serviceAccount.name }}
      restartPolicy: OnFailure
      containers:
        - name: apply-policy
          image: {{ .Values.images.installer.repository }}:{{ .Values.images.installer.tag }}
          imagePullPolicy: {{ .Values.images.installer.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for Kyverno CRD to be established..."
              kubectl wait --for=condition=Established crd/clusterpolicies.kyverno.io --timeout=300s
              echo "Waiting for Kyverno admission controller to be ready..."
              kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=admission-controller -n {{ .Values.charts.kyverno.namespace }} --timeout=120s
              kubectl apply -f /policy/policy.yaml
          volumeMounts:
            - name: policy
              mountPath: /policy
      volumes:
        - name: policy
          configMap:
            name: {{ .Release.Name }}-kyverno-zero-resources-policy
{{- end }}
