{{- if index .Values.conditionalPackageInstalls "etcd-operator" }}
# Job to create EtcdCluster after Aenix etcd-operator is installed
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-create-etcd-cluster
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 10
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: {{ .Values.installer.serviceAccount.name }}
      restartPolicy: OnFailure
      containers:
      - name: create-etcd
        image: {{ .Values.images.installer.repository }}:{{ .Values.images.installer.tag }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for etcd-operator CRD to be available..."
          until kubectl get crd etcdclusters.etcd.aenix.io 2>/dev/null; do
            echo "CRD not ready, waiting..."
            sleep 5
          done
          echo "CRD is ready, waiting for etcd-operator..."
          kubectl wait --for=condition=available deployment/etcd-operator-controller-manager -n etcd-operator-system --timeout=300s || true
          sleep 5
          
          echo "Creating EtcdCluster..."
          cat <<EOF | kubectl apply -f -
          apiVersion: etcd.aenix.io/v1alpha1
          kind: EtcdCluster
          metadata:
            name: etcd
            namespace: {{ .Release.Namespace }}
          spec:
            replicas: {{ .Values.etcdCluster.replicas | default 1 }}
            {{- if .Values.etcdCluster.storageClass }}
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: {{ .Values.etcdCluster.storageClass }}
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: {{ .Values.etcdCluster.storageCapacity | default "1Gi" }}
            {{- else }}
            storage:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: {{ .Values.etcdCluster.storageCapacity | default "1Gi" }}
            {{- end }}
            podTemplate:
              spec:
                containers:
                - name: etcd
                  resources:
                    requests:
                      cpu: {{ .Values.etcdCluster.cpu | default "100m" }}
                      memory: {{ .Values.etcdCluster.memory | default "256Mi" }}
                    limits:
                      cpu: {{ .Values.etcdCluster.cpu | default "100m" }}
                      memory: {{ .Values.etcdCluster.memory | default "256Mi" }}
          EOF
          
          echo "EtcdCluster created successfully"
{{- end }}
