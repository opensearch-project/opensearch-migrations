{{- if index .Values.conditionalPackageInstalls "etcd-druid" }}
# Job to create Etcd cluster after etcd-druid operator is installed
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-create-etcd-cluster
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 10
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: {{ .Values.installer.serviceAccount.name }}
      restartPolicy: OnFailure
      containers:
      - name: create-etcd
        image: {{ .Values.images.installer.repository }}:{{ .Values.images.installer.tag }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for etcd-druid CRD to be available..."
          until kubectl get crd etcds.druid.gardener.cloud 2>/dev/null; do
            echo "CRD not ready, waiting..."
            sleep 5
          done
          echo "CRD is ready, waiting for etcd-druid operator..."
          kubectl wait --for=condition=available deployment/etcd-druid -n etcd-druid --timeout=300s || true
          sleep 10
          
          echo "Creating Etcd cluster..."
          cat <<EOF | kubectl apply -f -
          apiVersion: druid.gardener.cloud/v1alpha1
          kind: Etcd
          metadata:
            name: {{ .Release.Name }}-etcd
            namespace: {{ .Release.Namespace }}
          spec:
            replicas: {{ .Values.etcdCluster.replicas | default 3 }}
            labels:
              app.kubernetes.io/name: etcd
              app.kubernetes.io/instance: {{ .Release.Name }}
            etcd:
              image: europe-docker.pkg.dev/gardener-project/releases/gardener/etcd-wrapper:v0.6.0
              defragmentationSchedule: "0 */24 * * *"
              resources:
                requests:
                  cpu: {{ .Values.etcdCluster.cpu }}
                  memory: {{ .Values.etcdCluster.memory }}
                limits:
                  cpu: {{ .Values.etcdCluster.cpu }}
                  memory: {{ .Values.etcdCluster.memory }}
            storageCapacity: {{ .Values.etcdCluster.storageCapacity | default "10Gi" }}
            backup:
              image: europe-docker.pkg.dev/gardener-project/releases/gardener/etcdbrctl:v0.40.0
              port: 8080
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
          EOF
          
          echo "Creating etcd client service..."
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: etcd
            namespace: {{ .Release.Namespace }}
          spec:
            type: ClusterIP
            selector:
              app.kubernetes.io/name: {{ .Release.Name }}-etcd
            ports:
            - name: client
              port: 2379
              targetPort: 2379
          EOF
          
          echo "Etcd cluster created successfully"
{{- end }}
