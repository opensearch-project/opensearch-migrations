{{ $envMountName := "env-vars" }}
{{ $snapshotVolumeEnabled := .Values.snapshotVolumeEnabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "generic.fullname" . }}
spec:
  replicas: 0
  selector:
    matchLabels:
      app: {{ include "generic.fullname" . }}
  template:
    metadata:
      labels:
        app: {{ include "generic.fullname" . }}
        env: v1
    spec:
      initContainers:
        {{- include "generic.setupEnvLoadInitContainer" (merge . (dict
           "MountName" $envMountName
           "include" .Template.Include)) | nindent 8 }}
      containers:
        - name: bulk-load
          image: migrations/reindex_from_snapshot:latest
          imagePullPolicy: IfNotPresent
          command:
            - "/bin/sh"
            - "-c"
            - |
              echo `cat /shared/vars.sh`
              source /shared/vars.sh
              {{/* Replace '|' with a space. This replacing only gets us back to our original state, it would only allow
              strings with spaces as arguments if we were to provide the args directrly to the java app in an array
              like in other services  */}}
              clean_args=$(echo "$ARGS" | sed 's/|/ /g')
              export RFS_COMMAND="/rfs-app/runJavaWithClasspath.sh org.opensearch.migrations.RfsMigrateDocuments $clean_args"
              exec /rfs-app/entrypoint.sh
          volumeMounts:
            - name: {{ $envMountName }}
              mountPath: /shared
            {{- if $snapshotVolumeEnabled }}
            - name: snapshot-volume
              mountPath: /snapshot
            {{- end }}
      volumes:
        - name: {{ $envMountName }}
          emptyDir: {}
        {{- if $snapshotVolumeEnabled }}
        - name: snapshot-volume
          persistentVolumeClaim:
            claimName: {{ .Values.snapshotVolumePvc }}
        {{- end }}
