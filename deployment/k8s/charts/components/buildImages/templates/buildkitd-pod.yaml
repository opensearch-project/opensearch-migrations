{{- if .Values.deployBuildkitPods }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: buildkitd-config
  namespace: {{ .Values.namespace }}
data:
  buildkitd.toml: |
    [registry."docker-registry:5000"]
    http = true
    [worker.oci]
    max-parallelism = {{ .Values.buildkitd.maxParallelism }}
{{- if .Values.multiArchNative }}
{{- range $arch := list "amd64" "arm64" }}
---
apiVersion: v1
kind: Service
metadata:
  name: buildkitd-{{ $arch }}
  namespace: {{ $.Values.namespace }}
spec:
  selector:
    app: buildkitd-{{ $arch }}
  ports:
    - name: buildkit
      protocol: TCP
      port: 1234
      targetPort: 1234
  type: ClusterIP
---
apiVersion: v1
kind: Pod
metadata:
  name: buildkitd-{{ $arch }}
  namespace: {{ $.Values.namespace }}
  labels:
    app: buildkitd-{{ $arch }}
spec:
  serviceAccountName: {{ $.Values.serviceAccountName }}
  nodeSelector:
    kubernetes.io/arch: {{ $arch }}
  tolerations:
    - key: "build-nodepool"
      operator: "Equal"
      value: "true"
      effect: "NoSchedule"
  containers:
    - name: buildkitd
      image: {{ .Values.buildkitImage | default "mirror.gcr.io/moby/buildkit:v0.22.0" }}
      args: [
        "--addr", "tcp://0.0.0.0:1234",
        "--config", "/etc/buildkit/buildkitd.toml"
      ]
      ports:
        - containerPort: 1234
      securityContext:
        privileged: true
      volumeMounts:
        - name: buildkitd-config
          mountPath: /etc/buildkit
          readOnly: true
      resources:
        requests:
{{- if and $.Values.buildkitd.resources.requests.cpu (ne (toString $.Values.buildkitd.resources.requests.cpu) "0") }}
          cpu: {{ $.Values.buildkitd.resources.requests.cpu | quote }}
{{- end }}
{{- if and $.Values.buildkitd.resources.requests.memory (ne (toString $.Values.buildkitd.resources.requests.memory) "0") }}
          memory: {{ $.Values.buildkitd.resources.requests.memory | quote }}
{{- end }}
{{- if and $.Values.buildkitd.resources.requests.ephemeralStorage (ne (toString $.Values.buildkitd.resources.requests.ephemeralStorage) "0") }}
          ephemeral-storage: {{ $.Values.buildkitd.resources.requests.ephemeralStorage | quote }}
{{- end }}
        limits:
{{- if and $.Values.buildkitd.resources.limits.cpu (ne (toString $.Values.buildkitd.resources.limits.cpu) "0") }}
          cpu: {{ $.Values.buildkitd.resources.limits.cpu | quote }}
{{- end }}
{{- if and $.Values.buildkitd.resources.limits.memory (ne (toString $.Values.buildkitd.resources.limits.memory) "0") }}
          memory: {{ $.Values.buildkitd.resources.limits.memory | quote }}
{{- end }}
{{- if and $.Values.buildkitd.resources.limits.ephemeralStorage (ne (toString $.Values.buildkitd.resources.limits.ephemeralStorage) "0") }}
          ephemeral-storage: {{ $.Values.buildkitd.resources.limits.ephemeralStorage | quote }}
{{- end }}
  volumes:
    - name: buildkitd-config
      configMap:
        name: buildkitd-config
  restartPolicy: Always
{{- end }}
{{- else }}
---
apiVersion: v1
kind: Service
metadata:
  name: buildkitd
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: buildkitd
  ports:
    - name: buildkit
      protocol: TCP
      port: 1234
      targetPort: 1234
  type: ClusterIP
---
apiVersion: v1
kind: Pod
metadata:
  name: buildkitd
  namespace: {{ .Values.namespace }}
  labels:
    app: buildkitd
spec:
  serviceAccountName: {{ .Values.serviceAccountName }}
  containers:
    - name: buildkitd
      image: {{ .Values.buildkitImage | default "mirror.gcr.io/moby/buildkit:v0.22.0" }}
      args: [
        "--addr", "tcp://0.0.0.0:1234",
        "--config", "/etc/buildkit/buildkitd.toml"
      ]
      ports:
        - containerPort: 1234
      securityContext:
        privileged: true
      volumeMounts:
        - name: buildkitd-config
          mountPath: /etc/buildkit
          readOnly: true
      resources:
        requests:
{{- if and .Values.buildkitd.resources.requests.cpu (ne (toString .Values.buildkitd.resources.requests.cpu) "0") }}
          cpu: {{ .Values.buildkitd.resources.requests.cpu | quote }}
{{- end }}
{{- if and .Values.buildkitd.resources.requests.memory (ne (toString .Values.buildkitd.resources.requests.memory) "0") }}
          memory: {{ .Values.buildkitd.resources.requests.memory | quote }}
{{- end }}
{{- if and .Values.buildkitd.resources.requests.ephemeralStorage (ne (toString .Values.buildkitd.resources.requests.ephemeralStorage) "0") }}
          ephemeral-storage: {{ .Values.buildkitd.resources.requests.ephemeralStorage | quote }}
{{- end }}
        limits:
{{- if and .Values.buildkitd.resources.limits.cpu (ne (toString .Values.buildkitd.resources.limits.cpu) "0") }}
          cpu: {{ .Values.buildkitd.resources.limits.cpu | quote }}
{{- end }}
{{- if and .Values.buildkitd.resources.limits.memory (ne (toString .Values.buildkitd.resources.limits.memory) "0") }}
          memory: {{ .Values.buildkitd.resources.limits.memory | quote }}
{{- end }}
{{- if and .Values.buildkitd.resources.limits.ephemeralStorage (ne (toString .Values.buildkitd.resources.limits.ephemeralStorage) "0") }}
          ephemeral-storage: {{ .Values.buildkitd.resources.limits.ephemeralStorage | quote }}
{{- end }}
  volumes:
    - name: buildkitd-config
      configMap:
        name: buildkitd-config
  restartPolicy: Always
{{- end }}
{{- end }}
