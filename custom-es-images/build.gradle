import groovy.json.JsonSlurper
import org.opensearch.migrations.image.RegistryImageBuildUtils.Registry
import org.opensearch.migrations.image.ImageRegistryFormatterFactory

def versionsFile = file('versions.json')
def versions = new JsonSlurper().parse(versionsFile) as Map<String, Map>
def imagePrefix = findProperty('esImagePrefix') ?: 'custom-elasticsearch'

// Opt-in push: -PpushVersions=7.10,7.17
def pushVersionsList = (findProperty('pushVersions') ?: '').toString()
        .split(',').collect { it.trim() }.findAll { it }

def correttoVersion = { String minor ->
    def parts = minor.split('\\.')
    int maj = parts[0] as int, min = parts[1] as int
    if (maj <= 5 || (maj == 6 && min <= 4)) return '8'
    if (maj == 6 || (maj == 7 && min <= 10)) return '11'
    if (maj == 7) return '17'
    return '21'
}

// Corretto version → base image and JAVA_HOME (inlined in task configs for configuration cache compat)
// Corretto 8: amazoncorretto:8-alpine (small, no JavaFX/GTK bloat)
// Corretto 11+: amazoncorretto headless images on AL2023

versions.each { minor, info ->
    def safeName = minor.replace('.', '_')
    def version = info.version
    def url = info.url

    // Resolve all values at configuration time (required for Gradle configuration cache)
    def parts = minor.split('\\.')
    int maj = parts[0] as int, min = parts[1] as int
    def corretto = (maj <= 5 || (maj == 6 && min <= 4)) ? '8' :
                   (maj == 6 || (maj == 7 && min <= 10)) ? '11' :
                   (maj == 7) ? '17' : '21'
    def base = corretto == '8' ? "amazoncorretto:8-alpine" : "amazoncorretto:${corretto}-al2023-headless"
    def javaHome = corretto == '8' ? '/usr/lib/jvm/java-8-amazon-corretto' : "/usr/lib/jvm/java-${corretto}-amazon-corretto"

    // Local docker build — Dockerfile downloads the tarball using TARGETARCH for multi-arch
    tasks.register("buildImage_${safeName}", Exec) {
        group = 'docker'
        description = "Build ${imagePrefix}:${version}"
        inputs.file('dockerfiles/Dockerfile')
        inputs.property('version', version)
        def dockerfilePath = file('dockerfiles/Dockerfile').absolutePath
        def contextPath = file('dockerfiles').absolutePath
        doFirst {
            commandLine 'docker', 'build',
                    '--build-arg', "CORRETTO_VERSION=${corretto}",
                    '--build-arg', "BASE_IMAGE=${base}",
                    '--build-arg', "JAVA_HOME_PATH=${javaHome}",
                    '--build-arg', "ES_VERSION=${version}",
                    '--build-arg', "TARBALL_URL=${url}",
                    '-f', dockerfilePath,
                    '-t', "${imagePrefix}:${version}",
                    contextPath
        }
    }
}

// Aggregate tasks
tasks.register('buildAll') {
    group = 'docker'
    description = 'Build all ES images locally'
    dependsOn tasks.matching { it.name.startsWith('buildImage_') }
}

// Per-major aggregate tasks
[1, 2, 5, 6, 7, 8].each { major ->
    def majorVersions = versions.keySet().findAll { it.startsWith("${major}.") }
    if (!majorVersions.isEmpty()) {
        tasks.register("buildMajor_${major}") {
            group = 'docker'
            description = "Build all ES ${major}.x images"
            dependsOn majorVersions.collect { "buildImage_${it.replace('.', '_')}" }
        }
    }
}

// Core test images — versions used in SupportedClusters.sources() + K8s workflows
tasks.register('buildCoreTestImages') {
    group = 'docker'
    description = 'Build ES images needed for core integration tests'
    dependsOn 'buildImage_8_19', 'buildImage_7_17', 'buildImage_7_10',
              'buildImage_6_8', 'buildImage_5_6', 'buildImage_2_4',
              'buildImage_1_7', 'buildImage_1_5'
}

// Registry push tasks — opt-in via -PpushVersions=7.10,7.17
if (!pushVersionsList.isEmpty()) {
    def publishedUrl = rootProject.findProperty('registryEndpoint') ?: 'localhost:5001'
    def registry = new Registry(publishedUrl.toString())
    def formatter = ImageRegistryFormatterFactory.getFormatter(registry.containerUrl)
    def builder = rootProject.findProperty('builder') ?: 'default'

    pushVersionsList.each { minor ->
        def info = versions[minor]
        if (!info) {
            throw new GradleException("Unknown ES version in pushVersions: ${minor}")
        }
        def safeName = minor.replace('.', '_')
        def version = info.version
        def url = info.url
        def (dest, cacheDest) = formatter.getFullTargetImageIdentifier(
                registry.containerUrl, "custom_elasticsearch", version, null)

        tasks.register("pushImage_${safeName}", Exec) {
            group = 'docker'
            description = "Build and push ${imagePrefix}:${version} to ${registry.containerUrl}"
            def pushParts = minor.split('\\.')
            int pushMaj = pushParts[0] as int, pushMin = pushParts[1] as int
            def corretto = (pushMaj <= 5 || (pushMaj == 6 && pushMin <= 4)) ? '8' :
                           (pushMaj == 6 || (pushMaj == 7 && pushMin <= 10)) ? '11' :
                           (pushMaj == 7) ? '17' : '21'
            def base = corretto == '8' ? "amazoncorretto:8-alpine" : "amazoncorretto:${corretto}-al2023-headless"
            def javaHome = corretto == '8' ? '/usr/lib/jvm/java-8-amazon-corretto' : "/usr/lib/jvm/java-${corretto}-amazon-corretto"
            def dockerfilePath = file('dockerfiles/Dockerfile').absolutePath
            def contextPath = file('dockerfiles').absolutePath
            doFirst {
                def buildArgs = [
                        "docker buildx build",
                        "--platform linux/amd64",
                        "--builder ${builder}",
                        "-f ${dockerfilePath}",
                        "--build-arg CORRETTO_VERSION=${corretto}",
                        "--build-arg BASE_IMAGE=${base}",
                        "--build-arg JAVA_HOME_PATH=${javaHome}",
                        "--build-arg ES_VERSION=${version}",
                        "--build-arg TARBALL_URL=${url}",
                        "-t ${dest}",
                        "--push",
                        "--cache-to=type=registry,ref=${cacheDest},mode=max",
                        "--cache-from=type=registry,ref=${cacheDest}",
                        contextPath
                ]
                commandLine 'sh', '-c', buildArgs.join(" ")
            }
        }
    }

    tasks.register('pushAll') {
        group = 'docker'
        description = 'Push all opt-in ES images to registry'
        dependsOn tasks.matching { it.name.startsWith('pushImage_') }
    }
}
