package org.opensearch.migrations.metadata.tracing;

import org.opensearch.migrations.bulkload.tracing.IRfsContexts;
import org.opensearch.migrations.bulkload.tracing.RfsContexts;
import org.opensearch.migrations.tracing.BaseNestedSpanContext;
import org.opensearch.migrations.tracing.BaseSpanContext;
import org.opensearch.migrations.tracing.CommonScopedMetricInstruments;
import org.opensearch.migrations.tracing.IScopedInstrumentationAttributes;

import io.opentelemetry.api.metrics.Meter;
import lombok.NonNull;

public interface MetadataMigrationContexts {
    class ClusterMetadataContext extends BaseSpanContext<RootMetadataMigrationContext>
        implements
            IMetadataMigrationContexts.IClusterMetadataContext {

        protected ClusterMetadataContext(RootMetadataMigrationContext rootScope) {
            super(rootScope);
            initializeSpan(rootScope);
        }

        @Override
        public String getActivityName() {
            return ACTIVITY_NAME;
        }

        @Override
        public IScopedInstrumentationAttributes getEnclosingScope() {
            return null;
        }

        public static class MetricInstruments extends CommonScopedMetricInstruments {
            private MetricInstruments(Meter meter, String activityName) {
                super(meter, activityName);
            }
        }

        public static @NonNull MetricInstruments makeMetrics(Meter meter) {
            return new MetricInstruments(meter, ACTIVITY_NAME);
        }

        @Override
        public MetricInstruments getMetrics() {
            return getRootInstrumentationScope().metadataMetrics;
        }

        @Override
        public IMetadataMigrationContexts.ITemplateContext createMigrateLegacyTemplateContext() {
            return new MigrateTemplateContext(rootInstrumentationScope, this);
        }

        @Override
        public IRfsContexts.ICheckedIdempotentPutRequestContext createComponentTemplateContext() {
            return new RfsContexts.CheckedIdempotentPutRequestContext(
                rootInstrumentationScope,
                this,
                "createComponentTemplateContext"
            );
        }

        @Override
        public IRfsContexts.ICheckedIdempotentPutRequestContext createMigrateTemplateContext() {
            return new RfsContexts.CheckedIdempotentPutRequestContext(
                rootInstrumentationScope,
                this,
                "createGetSnapshotContext"
            );
        }
    }

    class MigrateTemplateContext extends BaseNestedSpanContext<
        RootMetadataMigrationContext,
        IMetadataMigrationContexts.IClusterMetadataContext> implements IMetadataMigrationContexts.ITemplateContext {

        protected MigrateTemplateContext(
            RootMetadataMigrationContext rootScope,
            IMetadataMigrationContexts.IClusterMetadataContext enclosingScope
        ) {
            super(rootScope, enclosingScope);
            initializeSpan(rootScope);
        }

        @Override
        public String getActivityName() {
            return ACTIVITY_NAME;
        }

        public static class MetricInstruments extends CommonScopedMetricInstruments {
            private MetricInstruments(Meter meter, String activityName) {
                super(meter, activityName);
            }
        }

        public static @NonNull MetricInstruments makeMetrics(Meter meter) {
            return new MetricInstruments(meter, ACTIVITY_NAME);
        }

        @Override
        public MetricInstruments getMetrics() {
            return getRootInstrumentationScope().indexTemplateInstruments;
        }

        @Override
        public IRfsContexts.IRequestContext createCheckRequestContext() {
            return new RfsContexts.GenericRequestContext(rootInstrumentationScope, this, "createCheckRequestContext");
        }

        @Override
        public IRfsContexts.IRequestContext createPutContext() {
            return new RfsContexts.GenericRequestContext(rootInstrumentationScope, this, "createPutContext");
        }
    }

    class CreateIndexContext extends BaseSpanContext<RootMetadataMigrationContext>
        implements
            IMetadataMigrationContexts.ICreateIndexContext {

        protected CreateIndexContext(RootMetadataMigrationContext rootScope) {
            super(rootScope);
            initializeSpan(rootScope);
        }

        @Override
        public String getActivityName() {
            return ACTIVITY_NAME;
        }

        @Override
        public IScopedInstrumentationAttributes getEnclosingScope() {
            return null;
        }

        public static class MetricInstruments extends CommonScopedMetricInstruments {
            private MetricInstruments(Meter meter, String activityName) {
                super(meter, activityName);
            }
        }

        public static @NonNull MetricInstruments makeMetrics(Meter meter) {
            return new MetricInstruments(meter, ACTIVITY_NAME);
        }

        @Override
        public MetricInstruments getMetrics() {
            return getRootInstrumentationScope().createIndexInstruments;
        }

        @Override
        public IRfsContexts.IRequestContext createCheckRequestContext() {
            return new RfsContexts.GenericRequestContext(
                rootInstrumentationScope,
                this,
                "CreateIndexContext.createCheckRequestContext"
            );
        }

        @Override
        public IRfsContexts.IRequestContext createPutContext() {
            return new RfsContexts.GenericRequestContext(
                rootInstrumentationScope,
                this,
                "CreateIndexContext.createPutContext"
            );
        }
    }
}
