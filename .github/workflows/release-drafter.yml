name: Release drafter

on:
  push:
    branches:
      - fix-release-sbom-workflow
  workflow_dispatch:

env:
  java-version: '17'
  gradle-version: '8.12.1'

permissions:
  id-token: write
  contents: write
  issues: write

jobs:
  draft-a-release:
    name: Draft a release
    runs-on: ubuntu-22.04
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
    steps:
      - name: Alias docker-registry to 127.0.0.1
        run: |
          echo "127.0.0.1 docker-registry" | sudo tee -a /etc/hosts
          getent hosts docker-registry
          curl -sS http://docker-registry:5000/v2/ || true
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-env
      - id: get_data
        run: |
          echo "approvers=$(cat .github/CODEOWNERS | grep @ | tr -d '*\n ' | sed 's/@/,/g' | sed 's/,//1')" >> $GITHUB_OUTPUT
          VERSION="${GITHUB_REF#refs/tags/}"
          if [[ "$VERSION" == refs/heads/* ]]; then
            VERSION="test-$(date +%Y%m%d%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_safe=$(echo "$VERSION" | tr '/:@' '---')" >> $GITHUB_OUTPUT
      - name: Set up QEMU (for arm64 emulation)
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx builder (BuildKit)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          buildkitd-flags: --debug
          name: local-remote-builder
          install: true
          driver-opts: network=host
          buildkitd-config-inline: |
            [registry."docker-registry:5000"]
              http = true
              insecure = true
      - name: Build Docker Images to local registry
        env:
          OS_MIGRATIONS_GRADLE_SCAN_TOS_AGREE_AND_ENABLED: ''
        run: |
          ./gradlew :buildImages:buildImagesToRegistry_amd64 \
            -PintermediateRegistry=docker-registry:5000 \
            -PregistryEndpoint=docker-registry:5000 \
            -Pbuilder=local-remote-builder \
            -Dbuild.snapshot=false \
            -Dbuild.version=0.${{ steps.get_data.outputs.version }} \
            --no-build-cache \
            --no-configuration-cache \
            --no-daemon \
            --no-continue \
            --info
      - name: List images in local registry
        run: |
          curl -sS http://docker-registry:5000/v2/_catalog || true
          curl -sS http://docker-registry:5000/v2/migrations/migration_console/tags/list || true
      - name: Pull images from local registry for SBOM scanning
        run: |
          docker pull docker-registry:5000/migrations/migration_console:latest || echo "Failed to pull migration_console"
          docker pull docker-registry:5000/migrations/traffic_replayer:latest || echo "Failed to pull traffic_replayer"
          docker pull docker-registry:5000/migrations/capture_proxy:latest || echo "Failed to pull capture_proxy"
          docker pull docker-registry:5000/migrations/reindex_from_snapshot:latest || echo "Failed to pull reindex_from_snapshot"
          # Tag them for SBOM scanning
          docker tag docker-registry:5000/migrations/migration_console:latest migrations/migration_console:latest || true
          docker tag docker-registry:5000/migrations/traffic_replayer:latest migrations/traffic_replayer:latest || true
          docker tag docker-registry:5000/migrations/capture_proxy:latest migrations/capture_proxy:latest || true
          docker tag docker-registry:5000/migrations/reindex_from_snapshot:latest migrations/reindex_from_snapshot:latest || true
      - name: List Docker Images
        run: docker images
      - name: Generate SBOM for migration_console
        uses: anchore/sbom-action@v0.20.11
        with:
          image: migrations/migration_console:latest
          output-file: opensearch-migrations-console-sbom.spdx.json
      - name: Generate SBOM for traffic_replayer
        uses: anchore/sbom-action@v0.20.11
        with:
          image: migrations/traffic_replayer:latest
          output-file: opensearch-migrations-traffic-replayer-sbom.spdx.json
      - name: Generate SBOM for capture_proxy
        uses: anchore/sbom-action@v0.20.11
        with:
          image: migrations/capture_proxy:latest
          output-file: opensearch-migrations-traffic-capture-proxy-sbom.spdx.json
      - name: Generate SBOM for reindex_from_snapshot
        uses: anchore/sbom-action@v0.20.11
        with:
          image: migrations/reindex_from_snapshot:latest
          output-file: opensearch-migrations-reindex-from-snapshot-sbom.spdx.json
